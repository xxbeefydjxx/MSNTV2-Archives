<HTML>
	<!--

	Shell.html

	Shell.html is a script-only HTML document that is loaded into an off-screen browser
	context.  It remains active for the lifetime of the application and manages state
	transitions and event handlers.

-->

	<HEAD>
		<SCRIPT language="Javascript" src="../Javascript/TVShell.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/Panels.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/ServiceList.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/ConnectionManager.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/ConnectionErrors.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/MSNTVService.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/VKCodes.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/ProgressPanel.js"></SCRIPT>
		<SCRIPT language="Javascript" src="../Javascript/SupportedPrinters.js"></SCRIPT>
		<script language=javascript src="../Javascript/Patcher.js"></script>
		<script language=javascript src="../Javascript/Wireless.js"></script>
		<script language=javascript src="../Javascript/HomeNetworking.js"></script>
		<script src="msntv:/Javascript/Provisioning.js"></script>
		<script language=javascript src="../Javascript/ContentPaneHelp.js"></script>
		<SCRIPT language=javascript>

	TVShell.Message("MSNTV: Shell.html starting...\n");

	// Individual panel definitions:
	// function Panel(name, URL, type, style, z_order, historySize, destroyBrowserOnHide);

	var PanelManager = TVShell.PanelManager;
	var DeviceControl = TVShell.DeviceControl;
    var HomeNetworking = null;
	var flavor = TVShell.SystemInfo.Flavor;
	var screenWidth  = screen.availWidth;
	var screenHeight = screen.availHeight;

	var safeHeight = screenHeight;
	var safeWidth  = screenWidth;
	var safeBottom = screenHeight;
	var safeTop    = 0;
	var safeLeft   = 0;
	var playedHomeBrandSound = false;

	var lastSuppressedPopupURL = null;
	var popupControl = null;
	var popupControlBeingLoaded = null;

	var impanel;
	var mainPanel = PanelManager.Item("main");

	var FIND_PANEL_HEIGHT = 157;
	var PRINTSETTINGS_PANEL_HEIGHT =340;

	var SND_ASYNC = 0x0001;
	var SND_LOOP  = 0x0008;
	var connectingSoundID = 0;

	if (DeviceControl.UseSafeArea) {
		// Safe area excludes 1/16 of the total screen all around
		safeHeight -= screenHeight / 8;
		safeWidth  -= screenWidth  / 8;
		safeLeft = (screenWidth -  safeWidth)  / 2;
		safeTop  = (screenHeight - safeHeight) / 2;
		safeBottom = safeTop + safeHeight;
	}

	// Size and show the main panel.
	mainPanel.StartRect(safeLeft, safeTop, safeWidth, safeHeight);
	PanelManager.Show("main");

//	TVShell.Message("screen width: "+screenWidth);
//	TVShell.Message("screen height: "+screenHeight);
//	TVShell.Message("safe top: "+safeTop);
//	TVShell.Message("safe left: "+safeLeft);
//	TVShell.Message("safe width: "+safeWidth);
//	TVShell.Message("safe height: "+safeHeight);

	var statusHeight = 36;
	var statusTop = safeBottom - statusHeight;

	var statuspanel = new Panel("statusbar", "msntv:/Panels/statusBar.html",
								APP_PANEL_TYPE, STATIC_PANEL_STYLE, 80,0, false);
	statuspanel.selectable = false;
	statuspanel.start = new Rectangle(safeLeft, statusTop, safeWidth, statusHeight+safeTop);

	var menupanel = new Panel("menupanel", "msntv:/Panels/Menu.html",
								APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	menupanel.start = new Rectangle(safeLeft, screenHeight,
									safeWidth, LARGE_PANEL_HEIGHT);
	menupanel.end   = new Rectangle(safeLeft, safeBottom - LARGE_PANEL_HEIGHT,
									safeWidth, LARGE_PANEL_HEIGHT);

	var progresspanel = new Panel(PROGRESS_PANEL_NAME, "msntv:/Panels/Progress.html",
								  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,75,0,false);
	progresspanel.start = new Rectangle(safeLeft, screenHeight,
									safeWidth, PROGRESS_PANEL_HEIGHT);
	progresspanel.end   = new Rectangle(safeLeft, safeBottom - PROGRESS_PANEL_HEIGHT,
									safeWidth, PROGRESS_PANEL_HEIGHT);
	progresspanel.step = new Rectangle(0, screenHeight, 0, screenHeight);
	progresspanel.modal = true;
	progresspanel.transitionsoundenabled = false;

	var reconnectpanel = new Panel("reconnect", "msntv:/Panels/Reconnect.html",
								  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,75,0,false);
	reconnectpanel.start = new Rectangle(safeLeft, screenHeight,
									safeWidth, PROGRESS_PANEL_HEIGHT);
	reconnectpanel.end   = new Rectangle(safeLeft, safeBottom - PROGRESS_PANEL_HEIGHT,
									safeWidth, PROGRESS_PANEL_HEIGHT);
	reconnectpanel.modal = true;
	reconnectpanel.transitionsoundenabled = false;

	var idlewarnpanel = new Panel("idlewarn", "msntv:/Panels/IdleWarningPanel.html",
									SYSTEM_PANEL_TYPE, POPUP_PANEL_STYLE, 90, 0, false);
	idlewarnpanel.start = new Rectangle(safeLeft + ((safeWidth - LARGE_DIALOG_WIDTH) / 2),
									safeTop+50, LARGE_DIALOG_WIDTH, LARGE_DIALOG_HEIGHT);
	idlewarnpanel.end   = new Rectangle(safeLeft + ((safeWidth - LARGE_DIALOG_WIDTH) / 2),
									safeTop+50, LARGE_DIALOG_WIDTH, LARGE_DIALOG_HEIGHT);
	idlewarnpanel.modal = true;

	var alertpanel = new Panel("alert", "msntv:/Panels/Alert.html",
							   ALERT_PANEL_TYPE, SLIDING_PANEL_STYLE,90,0,false);
	alertpanel.start = new Rectangle(safeLeft, screenHeight,    safeWidth, 56);
	alertpanel.end   = new Rectangle(safeLeft, safeBottom - 56, safeWidth, 56);
	alertpanel.step = new Rectangle(10, 10, 10, 10);
	alertpanel.selectable = false;
	alertpanel.transitionsoundenabled = false;

	var gotopanel = new Panel("gotopanel", "msntv:/Panels/Goto.html",
							  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	gotopanel.start = new Rectangle(safeLeft, statusTop,                      safeWidth, LARGE_PANEL_HEIGHT);
	gotopanel.end   = new Rectangle(safeLeft, statusTop - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);

	var favoritespanel = new Panel("favoritespanel", "msntv:/Favorites/Favorites.html",
							  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	favoritespanel.start = new Rectangle(safeLeft, statusTop,                      safeWidth, LARGE_PANEL_HEIGHT);
	favoritespanel.end   = new Rectangle(safeLeft, statusTop - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);

	var recentpanel = new Panel("recentpanel", "msntv:/Panels/Recent.html",
								APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	recentpanel.start = new Rectangle(safeLeft, statusTop,                      safeWidth, LARGE_PANEL_HEIGHT);
	recentpanel.end   = new Rectangle(safeLeft, statusTop - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);

	var mediapanel = new Panel("mediapanel", "msntv:/media/media.htm",
							 APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	mediapanel.start = new Rectangle(safeLeft, screenHeight,                    safeWidth, LARGE_PANEL_HEIGHT);
	mediapanel.end   = new Rectangle(safeLeft, safeBottom - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);

    var sourcepanel = new Panel("source", "msntv:/Panels/sourcepanel.html",
								  SYSTEM_PANEL_TYPE, STATIC_PANEL_STYLE,100,0,true);
	sourcepanel.start = new Rectangle(safeLeft, safeTop, safeWidth, safeHeight);

    var findpanel = new Panel("find", "msntv:/tvshell/find.htm",
								  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	findpanel.start = new Rectangle(safeLeft, screenHeight,                   safeWidth, FIND_PANEL_HEIGHT);
	findpanel.end   = new Rectangle(safeLeft, safeBottom - FIND_PANEL_HEIGHT, safeWidth, FIND_PANEL_HEIGHT);

	impanel = new Panel("impanel", "msntv:/IM/IMPanel.html",
							APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	impanel.start = new Rectangle(safeLeft, statusTop,                      safeWidth, LARGE_PANEL_HEIGHT);
	impanel.end   = new Rectangle(safeLeft, statusTop - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);

	var autopanel = new Panel("autopanel", "msntv:/Autopanel/autopanel.htm",
							  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	autopanel.start = new Rectangle(safeLeft,                statusTop,       530, 320);
	autopanel.end   = new Rectangle((screenWidth - 530) / 2, statusTop - 320, 530, 320);
	
	var tourist = new Panel("tourist", "msntv:/Tourist/Tourist.htm",
							  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	tourist.start = new Rectangle(safeLeft, statusTop, 560,       370);
	tourist.end   = new Rectangle(safeLeft, safeTop,   safeWidth, safeHeight);

	var viewdocpanel = new Panel("viewdocpanel", "msntv:/Panels/ViewDocTree.html",
							  SYSTEM_PANEL_TYPE, STATIC_PANEL_STYLE,100,0,true);
	viewdocpanel.start = new Rectangle(safeLeft, safeTop, safeWidth, safeHeight);


	var printsettings = new Panel("printsettings", "msntv:/Panels/printsettings.html",
							  APP_PANEL_TYPE, SLIDING_PANEL_STYLE,60,0,false);
	printsettings.start = new Rectangle(safeLeft, screenHeight,                            safeWidth, PRINTSETTINGS_PANEL_HEIGHT);
	printsettings.end   = new Rectangle(safeLeft, safeBottom - PRINTSETTINGS_PANEL_HEIGHT, safeWidth, PRINTSETTINGS_PANEL_HEIGHT);

	var servicepanel = new Panel("service", "msntv:/Shell/empty.html",
								APP_PANEL_TYPE, STATIC_PANEL_STYLE, 1, 0, false);
	servicepanel.start = new Rectangle(0, 0, 0, 0);
	servicepanel.selectable = false;

	// DeviceControl
	var LED_Off 		= 0;
	var LED_On			= 1;
	var LED_BlinkSlow	= 2;
	var LED_BlinkMedium	= 3;
	var LED_BlinkFast	= 4;

	// Init object
	var PowerState_On = 0;
	var PowerState_Off = 1;

	// Used for IM reconnect
	MSTATE_UNKNOWN				= 0;
	MSTATE_OFFLINE				= 0x1;
	MLOGOFFREASON_UNKNOWN		= 0;
	MLOGOFFREASON_NETWORKDOWN	= 1;

	// Used for Diplomas settings
	MDIPLOMA_PAGESIZE	= 0x00000001;
	MDIPLOMA_TEXTRESIZE	= 0x00000002;
	MDIPLOMA_IM = 0x20;

	var LoginIMTimeoutID;
	
	function RemovePanel(name)
	{
		TVShell.BuiltinServiceList.Remove("panel::"+name);
		TVShell.ServiceList.Remove("panel::"+name);
		PanelManager.Remove(name);
	}

	//
	// AddPanels - Add all of the panels for a particular state that are specified
	//             in the shell's property list.
	//
	function AddPanels(state)
	{
		var PanelList = TVShell.Property("Panels\\"+state);
		var i;

		if (!PanelList)
			return;

		for (i = 0; i < PanelList.Count; i++) {
			var PanelName = PanelList.Tag(i);
			var PanelURL = PanelList(PanelName);
			if (PanelName && PanelURL) {
				TVShell.Message("AddPanels("+state+"): "+PanelName+" = "+PanelURL);
				var Panel = PanelManager.Add(PanelName);
				Panel.GotoURL(PanelURL);
			}
		}
	}

	//
	// RemovePanels - Remove any panels added by AddPanels for a particular state
	//
	function RemovePanels(state)
	{
		var PanelList = TVShell.Property("Panels\\"+state);
		var i;

		if (!PanelList)
			return;

		for (i = 0; i < PanelList.Count; i++) {
			var PanelName = PanelList.Tag(i);
			TVShell.Message("RemovePanels("+state+"): "+PanelName);
			RemovePanel(PanelName);
		}
	}

	//
	// Add the always-present offline panels
	//
	function AddOfflinePanels(PanelManager)
	{
		// Menu and Media panel added only if registered.
		if (IsRegistered()) {
			AddPanel(PanelManager, menupanel);
			SetPanelAccel(menupanel.name, FCONTROL, "O".charCodeAt(0));  // Ctrl+O
			SetPanelAccel(menupanel.name, 0, VK_F7);

			AddPanel(PanelManager, mediapanel);
			SetPanelAccel(mediapanel.name, FCONTROL, "W".charCodeAt(0));  // Ctrl+W
			SetPanelAccel(mediapanel.name, 0, VK_LAUNCH_MEDIA_SELECT);
		}

		AddPanel(PanelManager, progresspanel);
	    AddPanel(PanelManager, findpanel);

	    InitializePrinterModelList();
		AddPanel(PanelManager, printsettings);
		

		//
		// Add debug/test panels for non-release builds
		//
		if (flavor != "release" && flavor != "ppe") {
			AddPanel(PanelManager, autopanel);
			AddPanel(PanelManager, tourist);

			SetPanelAccel(autopanel.name,    		FCONTROL, "T".charCodeAt(0));  // Ctrl+T
			SetPanelAccel(tourist.name,      		FALT,     "t".charCodeAt(0));  // Alt+t

			//
			// Add these iff we are in devmode
			//
			var BootROM = new ActiveXObject("MSNTV.BootRom");
			BootROM.Read();

			if (BootROM.DebugMode) {
				AddPanel(PanelManager, sourcepanel);
				AddPanel(PanelManager, viewdocpanel);
				AddPanel(PanelManager, gotopanel);

				SetPanelAccel(sourcepanel.name,  		FALT,     "s".charCodeAt(0));  // Alt+s
				SetPanelAccel(viewdocpanel.name, 		FALT,     "d".charCodeAt(0));  // Alt+d
				SetPanelAccel(gotopanel.name,			FALT,     "g".charCodeAt(0));  // Alt+G
			}
		}

		AddPanels("Offline");
    }

	//
	// Remove all panels added by AddOfflinePanels
	//
	function RemoveOfflinePanels(PanelManager)
	{
		RemovePanel(menupanel.name);
		RemovePanel(mediapanel.name);
		RemovePanel(progresspanel.name);
	    RemovePanel(findpanel.name);
		RemovePanel(printsettings.name);

		//
		// Remove debug/test panels for non-release builds
		//
		if (flavor != "release" && flavor != "ppe") {
			RemovePanel(sourcepanel.name);
			//RemovePanel(autopanel.name); //Keeping automation panel up when box is powered off.
			//RemovePanel(tourist.name);		//Keeping tourist panel up when box power off for auto-tourist
			RemovePanel(viewdocpanel.name);
			RemovePanel(gotopanel.name);
		}

		RemovePanels("Offline");
    }

	function StartServicePanel(ConnectCause, PanelManager)
	{
		var ServicePanel = PanelManager.Item(servicepanel.name);

		if (!ServicePanel)
			ServicePanel = AddPanel(PanelManager, servicepanel);

		if (ServicePanel != null) {
			var entry;

			//
			// Look for a serviceEntry for the connection.  If there is none, pick an entry
			// for the service panel depending on mode and availability.
			//
			var connectionEntry = TVShell.BuiltinServiceList(CONNECTION_SERVICE_ENTRY);

			if (connectionEntry) {
				TVShell.BuiltinServiceList.Remove(CONNECTION_SERVICE_ENTRY);
				entry = connectionEntry;
			} else {
				if (ConnectCause == "connection::nightly_login")
					entry = TVShell.ServiceList("connection::nightly_login");
				else {
					//
					// If the service is authorized, then assume that we are only
					// reconnecting.
					//
					if (TVShell.ConnectionManager.ServiceState == Service_Authorized)
						entry = TVShell.ServiceList("connection::reconnect");

					//
					// If we are not reconnecting, then use the Service's login entry
					//
					if (!entry)
						entry = TVShell.ServiceList("connection::login");

					//
					// If the service has not given us a login entry, then fall back on prereg
					//
					if (!entry)
						entry = TVShell.ServiceList("connection::prereg");
				}
			}

			//
			// If we found an entry, then send the service panel to it
			//
			if (entry) {
				if (entry.Description != "")
					TVShell.Message("Connecting to "+entry.Description+" service...");

				var ServerError = ConnectError_NoError;
				
				if (!TVShell.ConnectionManager.HTTPProxy.Enabled)
					ServerError = TVShell.ConnectionManager.Resolver.VerifyURL(entry.URL, false);

				if (ServerError != ConnectError_NoError) {
					TVShell.Message("Verification of "+entry.URL+" failed with error "+ServerError);
					TVShell.ConnectionManager.WANAdapter.ErrorCode = ServerError;
					return;
				}

				ServicePanel.GotoURL(entry.URL);
				return;
			}
		}

		//
		// Oops! We either couldn't create a panel, or there is something missing
		// from the service list that we needed.
		//
		setTimeout("TVShell.ConnectionManager.WANDisconnect();", 500);
	}

	function EnableOfflineFeatures()
	{
		// set shortcuts for photos
		var entry = TVShell.BuiltinServiceList("Photos");
		if (entry) {
			entry.KeyCode = VK_F12;	// New MC value.
		}
	}

	function DisableOfflineFeatures()
	{
		// remove shortcuts for photo
		var entry = TVShell.BuiltinServiceList("Photos");
		if (entry) {
			entry.KeyCode = 0;
		}

	}

	function AddUserAuthorizedPanels(PanelManager)
	{
		// set shortcut for email 
		var ServiceList = TVShell.ServiceList;
		var BuiltinServiceList = TVShell.BuiltinServiceList;

		entry = TVShell.BuiltinServiceList("mail::listmail");
		if (entry) {
			entry.KeyCode = VK_LAUNCH_MAIL;
		} 
		
		EnableOfflineFeatures();
		AddPanel(PanelManager, statuspanel);
	}

	function AddUserAuthorizedPanels2(PanelManager)
	{
		// Show status panel
		PanelManager.Show(statuspanel.name);

		// Shorten main panel by the size of status panel
		mainPanel.StartRect(safeLeft, safeTop, safeWidth, statusTop - safeTop);

		// Adjust Menu Panel
		var menu = PanelManager.Item(menupanel.name);
		if (!menu) {
			menu = AddPanel(PanelManager, menupanel);
			SetPanelAccel(menupanel.name, FCONTROL, "O".charCodeAt(0));  // Don't use SetUserPanelAccel because of the offline menu panel
			SetPanelAccel(menupanel.name, 0, VK_F7);
		}
		menu.StartRect(safeLeft, statusTop, safeWidth, LARGE_PANEL_HEIGHT);
		menu.EndRect(safeLeft, statusTop - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);

		// Adjust Media Panel
		var media = PanelManager.Item(mediapanel.name);
		if (!media) {
			media = AddPanel(PanelManager, mediapanel);
			SetPanelAccel(mediapanel.name, FCONTROL, "W".charCodeAt(0));  // Ctrl+W
			SetPanelAccel(mediapanel.name, 0, VK_LAUNCH_MEDIA_SELECT);
		}
		media.StartRect(safeLeft, statusTop, safeWidth, LARGE_PANEL_HEIGHT);
		media.EndRect(safeLeft, statusTop - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);

		// Adjust Progress Panel
		var progress = PanelManager.Item(PROGRESS_PANEL_NAME);
		if (progress) {
			progress.StartRect(safeLeft, statusTop, safeWidth, PROGRESS_PANEL_HEIGHT);
			progress.EndRect(safeLeft, statusTop - PROGRESS_PANEL_HEIGHT, safeWidth, PROGRESS_PANEL_HEIGHT);
		}

		// Adjust Reconnect panel
		var reconnect = PanelManager.Item("reconnect");
		if (reconnect) {
			reconnect.StartRect(safeLeft, statusTop, safeWidth, PROGRESS_PANEL_HEIGHT);
			reconnect.EndRect(safeLeft, statusTop - PROGRESS_PANEL_HEIGHT, safeWidth, PROGRESS_PANEL_HEIGHT);
		}
		else {
			reconnectpanel.start = new Rectangle(safeLeft, statusTop, safeWidth, PROGRESS_PANEL_HEIGHT);
			reconnectpanel.end = new Rectangle(safeLeft, statusTop - PROGRESS_PANEL_HEIGHT, safeWidth, PROGRESS_PANEL_HEIGHT);
		}

		//Adjust Find Panel
		var findpanel=PanelManager.Item("find");
	    if (findpanel) {
			findpanel.StartRect(safeLeft, statusTop,     safeWidth, FIND_PANEL_HEIGHT);
			findpanel.EndRect(safeLeft, statusTop-FIND_PANEL_HEIGHT, safeWidth, FIND_PANEL_HEIGHT);
		}

		//Adjust PrintSettings Panel
		var PrintSettings=PanelManager.Item("printsettings");
	    if (PrintSettings) {
			PrintSettings.StartRect(safeLeft, statusTop,     safeWidth, PRINTSETTINGS_PANEL_HEIGHT);
			PrintSettings.EndRect(safeLeft, statusTop-PRINTSETTINGS_PANEL_HEIGHT, safeWidth, PRINTSETTINGS_PANEL_HEIGHT);
		}

		AddPanel(PanelManager, alertpanel);
		if (!PanelManager.Item(gotopanel.name)) {
			AddPanel(PanelManager, gotopanel);
		}
		AddPanel(PanelManager, favoritespanel);
		AddPanel(PanelManager, recentpanel);

		SetUserPanelAccel(gotopanel.name,      FCONTROL, "G".charCodeAt(0));  // Ctrl+G
		SetUserPanelAccel(gotopanel.name, 0, VK_F4);
		SetUserPanelAccel(favoritespanel.name, 0,        VK_BROWSER_FAVORITES); // Favs
		SetUserPanelAccelEx(favoritespanel.name, "save", FCONTROL, "S".charCodeAt(0), "add"); // Ctrl+S
		SetUserPanelAccelEx(favoritespanel.name, "save", 0, VK_F5, "add");
		SetUserPanelAccel(recentpanel.name,    FCONTROL, "R".charCodeAt(0));  // Ctrl+R
		SetUserPanelAccel(recentpanel.name,    0, VK_F9);

		if (TVShell.UserManager.CurrentUser.ServiceList.Item("messenger::root") != null) {
			AddPanel(PanelManager, impanel);
			SetUserPanelAccel(impanel.name,        0,        VK_F8);  // F8
		}
		else {
			entry = TVShell.BuiltinServiceList.Add("Messenger");
			entry.URL = "msntv:/OLTK/IMBlock.html";
			entry.Safe = true;
			entry.KeyCode = VK_F8;
		}

		AddPanels("User");
	}

	function StopLoadingMain()
	{
		SetProgressStopFunction(null);
		mainPanel.Stop();
		OnNavigateComplete2("main", mainPanel.URL);
	}

	function StopDownLoading()
	{
		SetProgressStopFunction(null);
		PanelManager.StopDownload();
		OnDownloadComplete("download");
	}

	function StopSlideShow()
	{
		if (IsMainPanelOnPage("msntv:/photo/SlideShow.html")) {
			TVShell.Message("Shell.html: Stopping slide show");
			mainPanel.GoBack();
		}
	}

	function OnDownloadBegin(name, fileName, domain)
	{
		if (name == "download") {
			TVShell.Message("Shell.html: OnDownloadBegin(download): " + fileName + " from " + domain);
			var CurrentPanel = PanelManager.FocusedPanel;
			if (!CurrentPanel || CurrentPanel.Name != "mediapanel") {
				if (IsMediumFile(fileName))
					SetProgressText(PROGRESS_PLEASE_WAIT_WHILE_GET + "your media ready.");
				else {
					if (domain != "")
						SetProgressText(PROGRESS_PLEASE_WAIT_WHILE_GET + fileName + " from " + domain+ ".");
					else
						SetProgressText(PROGRESS_PLEASE_WAIT_WHILE_GET + fileName + " ready.");
				}

				SetProgressStopFunction(StopDownLoading);

				ShowProgressPanel();
				Sink.AttachEvent(PanelManager, "OnProgressChange", OnProgressChange);
			}
		}

		if (name == "download" || name == "main")
			if (TVShell.ConnectionManager.WANState == ConnectState_Connected)
				DeviceControl.ConnectLED = LED_BlinkFast;
	}

	function OnBeforeNavigate2(name, url, isLocal)
	{
		TVShell.Message("Shell.html: OnBeforeNavigate2("+name+", "+url+", "+(isLocal ? "local" : "non-local")+"): ");
		if (name == "main" && !isLocal) {

			if (TVShell.ConnectionManager.WANState == ConnectState_Disconnected) {
				TVShell.Message("Shell.html: on-line navigate attempted from offline");
				return;
			}

			var CurrentPanel = PanelManager.FocusedPanel;
			if (!CurrentPanel || CurrentPanel.Name != "mediapanel") {
				if (IsMediumFile(url))
					SetProgressText(PROGRESS_PLEASE_WAIT_WHILE_GET + "your media ready.");
				else
					SetProgressText(PROGRESS_PLEASE_WAIT_WHILE_GET + "your page ready.");
				SetProgressStopFunction(StopLoadingMain);

				ShowProgressPanel();
				Sink.AttachEvent(PanelManager, "OnProgressChange", OnProgressChange);
				lastSuppressedPopupURL = null; // Clear last popup url.
			}
		}
	}

	function OnProgressChange(name, range)
	{
		if (name == "main" || name == "download") {
			SetProgressPercent(range);
		}
	}

	function OnDownloadComplete(name)
	{
		if (name == "download") {
			TVShell.Message("Shell.html: OnDownloadComplete("+ name + "): " + mainPanel.URL);
			Sink.DetachEvent(PanelManager, "OnProgressChange", OnProgressChange);
			HideProgressPanel();
		}

		if (name == "download" || name == "main") {
			if (TVShell.ConnectionManager.WANState == ConnectState_Connected)
				DeviceControl.ConnectLED = LED_On;
			else
				DeviceControl.ConnectLED = LED_Off;
		}
	}

	function OnNavigateComplete2(name, url)
	{
		if (name == "main") {
			TVShell.Message("Shell.html: OnNavigateComplete2("+ name + "): " + url);
			Sink.DetachEvent(PanelManager, "OnProgressChange", OnProgressChange);
			HideProgressPanel();
		}

		// This causes the pop up panel to show when we finish loading it
		if (name.indexOf("popup::") == 0 && TVShell.Property("ShowPopUps"))
			PanelManager.Show(name);
	}

	function RemovePopUpPanels()
	{
		var i;

		for (i = PanelManager.Count-1; i >= 0; i--)
			if (PanelManager.Item(i).Name.indexOf("popup::") == 0)
				PanelManager.Remove(i);
	}

	function RemoveUserAuthorizedPanels(PanelManager)
	{
		TVShell.Message("Shell.html - RemoveUserAuthorizedPanels");

		// Remove any pop-up panels
		RemovePopUpPanels()

		// remove shortcut for email 
		entry = TVShell.BuiltinServiceList("mail::listmail");
		if (entry) {
			entry.KeyCode = 0;
		} 
		
		RemovePanel(statuspanel.name);
		RemovePanel(alertpanel.name);
		if (flavor == "release" || flavor == "ppe") {
			RemovePanel(gotopanel.name);
		}
		else {
			SetUserPanelAccel(gotopanel.name, 0, 0);
		}
		RemovePanel(impanel.name);
		RemovePanel(favoritespanel.name);
		RemovePanel(recentpanel.name);

		var menu = PanelManager.Item(menupanel.name);
		if (menu) {
			menu.StartRect(safeLeft, screenHeight, safeWidth, LARGE_PANEL_HEIGHT);
			menu.EndRect(safeLeft, safeBottom - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);
		}
       
		var media = PanelManager.Item(mediapanel.name);
		if (media) {
			media.StartRect(safeLeft, screenHeight, safeWidth, LARGE_PANEL_HEIGHT);
			media.EndRect(safeLeft, safeBottom - LARGE_PANEL_HEIGHT, safeWidth, LARGE_PANEL_HEIGHT);
		}
       
		var progress = PanelManager.Item(PROGRESS_PANEL_NAME);
		if (progress) {
			progress.StartRect(safeLeft, screenHeight, safeWidth, PROGRESS_PANEL_HEIGHT);
			progress.EndRect(safeLeft, safeBottom - PROGRESS_PANEL_HEIGHT, safeWidth, PROGRESS_PANEL_HEIGHT);
		}

  		var reconnect = PanelManager.Item("reconnect");
		if (reconnect) {
			reconnect.StartRect(safeLeft, screenHeight, safeWidth, PROGRESS_PANEL_HEIGHT);
			reconnect.EndRect(safeLeft, safeBottom - PROGRESS_PANEL_HEIGHT, safeWidth, PROGRESS_PANEL_HEIGHT);
		}
		else {
			reconnectpanel.start = new Rectangle(safeLeft, screenHeight, safeWidth, PROGRESS_PANEL_HEIGHT);
			reconnectpanel.end = new Rectangle(safeLeft, safeBottom - PROGRESS_PANEL_HEIGHT, safeWidth, PROGRESS_PANEL_HEIGHT);
		}	
		
        //adjust Find panel 
		var findpanel = PanelManager.Item("find");
		if (findpanel) {
			findpanel.StartRect(safeLeft, screenHeight, safeWidth, FIND_PANEL_HEIGHT);
			findpanel.EndRect(safeLeft, safeBottom - FIND_PANEL_HEIGHT, safeWidth, FIND_PANEL_HEIGHT);
		}
        //adjust PrintSettings panel 
		var PrintSettings = PanelManager.Item("printsettings");
		if (PrintSettings) {
			PrintSettings.StartRect(safeLeft, screenHeight, safeWidth, PRINTSETTINGS_PANEL_HEIGHT);
			PrintSettings.EndRect(safeLeft, safeBottom - PRINTSETTINGS_PANEL_HEIGHT, safeWidth, PRINTSETTINGS_PANEL_HEIGHT);
		}
		mainPanel.StartRect(safeLeft, safeTop, safeWidth, safeHeight);

		RemovePanels("User");
	}

	function RemoveOnlinePanels(PanelManager)
	{
		RemovePanel(servicepanel.name);
		RemovePanel(idlewarnpanel.name);
	}

	function RemoveAllPanels(PanelManager)
	{
		RemoveUserAuthorizedPanels(PanelManager);
		RemoveOnlinePanels(PanelManager);
		RemoveOfflinePanels(PanelManager);

		RemovePanel(reconnectpanel.name);
		RemovePanel(progresspanel.name);
	}

	function NeedUpdate()
	{
		var rom = new ActiveXObject("MSNTV.BootRom");

		rom.Read();
		if (  rom.UpdateURL != "" && rom.Hash != "" ) {
			var updater = new ActiveXObject("MSNTV.UpdateDownload");
			if ( updater.UpdateCapable && !updater.RebootRequired ) {
				return true;
			}
		}
		var PersistentProperties = TVShell.Property("Persistent/");
		if ( PersistentProperties && PersistentProperties("UpdateLoopTestMode") == 1 ) {
			TVShell.Message("Starting with update loop test");
			return true;
		}
		return false;
	}
	
	function OnPowerOn(PowerCause)
	{
		DeviceControl.PowerLED = LED_BlinkSlow;

		// Unless we are powering up in un-attended mode, turn on UI sounds
		if (PowerCause != "NightlyUpdate")
			DeviceControl.PlayMute = false;

		DeviceControl.PlaySound("Power_On");
		playedHomeBrandSound = false;

		TVShell.URL = "msntv:/Shell/PowerOn.html";

		InitializeServiceList();
		AddOfflinePanels(PanelManager);

		TVShell.ActiveServiceList = TVShell.ServiceList;

		//
		// Determine starting URL
		//
		// In priority order:
		//
		//	1. "RunOnce" service list entry, deleted after first use
		//	2. "RunOnce" property list entry, deleted after first use
		//	3. "RunStart" service list entry
		//	4. "RunStart" property list entry
		//	5. Sign On (which has its own set of priorities)
		//
		var StartURL;

		// do update if required
		
		if (NeedUpdate() ) {
			TVShell.ScreenSaver.CurrentSaver = "Butterfly";
			StartURL = "msntv:/Update/FullUpdate.html";
		}

		if (!StartURL) {	
			var RunOnce = TVShell.ServiceList("RunOnce");
			if (RunOnce) {
				StartURL = RunOnce.URL;
				TVShell.ServiceList.Remove("RunOnce");
			}
		}

		if (!StartURL) {
			var RunOnce = TVShell.Property("RunOnce");
			if (RunOnce) {
				StartURL = RunOnce;
				TVShell.Property.Remove("RunOnce");
			}
		}

		if (!StartURL) {
			var RunStart = TVShell.ServiceList("RunStart");
			if (RunStart)
				StartURL = RunStart.URL;
		}

		if (!StartURL) {
			var RunStart = TVShell.Property("RunStart");
			if (RunStart)
				StartURL = RunStart;
		}


		
		if (StartURL)
			TVShell.URL = StartURL;
		else
			GotoSignOn();

		DeviceControl.TVEncoder.OutputEnable = true;
		TVShell.ScreenSaver.Enable = true;
		TVShell.PrintManager.LoadObject();

		//
		// Don't remember the power on state if we are just temporarily powering on,
		// otherwise keep track of it so that if we lose power, we will come back up in
		// whatever our previous state was.
		//
		if (PowerCause != "NightlyUpdate") {
			TVShell.Init.PowerState = PowerState_On;
			TVShell.Init.Save();

			var BootROM = new ActiveXObject("MSNTV.BootRom");

			BootROM.Read();
			BootROM.PowerOnState = true;
			BootROM.Flush();
		} 

		//
		// Enable offline features if the clock is set and we have a user list
		//
		if (IsRegistered())
			EnableOfflineFeatures();

		DeviceControl.PowerLED = LED_On;
		TVShell.FinishPowerOn();

		// Start LAN connection
		TVShell.ConnectionManager.LANConnect("LAN::Reconnect");
	}

	var ReadyState_Uninitialized = 0;
	var ReadyState_Loading = 1;
	var ReadyState_Loaded = 2;
	var ReadyState_Interactive = 3;
	var ReadyState_Complete = 4;

	function AllPanelsComplete(WaitCount)
	{
		for (i = PanelManager.Count-1; i >= 0; i--) {
			var WebBrowser = PanelManager.Item(i).WebBrowser;

			if (WebBrowser && WebBrowser.ReadyState < ReadyState_Complete) {
				TVShell.Message("AllPanelsComplete: Waiting for panel "+PanelManager.Item(i).Name+" in readystate "+WebBrowser.ReadyState+" count ="+WaitCount);

				if (WaitCount > 50) {
					TVShell.Reboot();
					return true; // Should remove panel?
				}

				if (WaitCount > 20)
					PanelManager.Item(i).Stop();

				return false;
			}
		}

		return true;
	}

	//
	// Wait for the network to disconnect and all panels to be complete before
	// completeting a power off sequence
	//
	function PowerOffWhenComplete(WaitCount)
	{
		if (AllPanelsComplete(WaitCount))
			switch (TVShell.ConnectionManager.WANState) {
				case ConnectState_Connected:
					TVShell.ConnectionManager.WANDisconnect();
					break;

				case ConnectState_Disconnected:
					// Tell the shell that we're ready to Power On again!
					DeviceControl.PowerLED = LED_Off;
					TVShell.FinishPowerOff();
					return;
			}

		setTimeout("PowerOffWhenComplete("+(WaitCount+1)+");", 200);
	}

	function OnPowerOff()
	{

		// Start the LED indicator to show that we're working
		DeviceControl.PowerLED = LED_BlinkSlow;

		// Turn off UI sounds
		DeviceControl.PlayMute = true;

        // cleanup homenetworking object: umount all shares and loose passwords that are mark as 'no save'
	    if (HomeNetworking) {   
            HomeNetworking.PowerOff();
	    }

		//persist print setting 
		TVShell.PrintManager.SaveObject();

		// Switch to main panel
		PanelManager.Show("main");

		// Remove all panels (except for main)
		RemoveAllPanels(PanelManager);

		// Sign out the current user
		TVShell.UserManager.ClearCurrentUser();

		// If a user was authorized, then the MeterManager, PolicyManager,
		// and LoginManager would have already been cleaned up.

		// No need for metering
		TVShell.MeteringManager.Stop();

		// Cleanup on PolicyManager and LoginManager
		TVShell.PolicyManager.Cleanup();
		TVShell.LoginManager.Cleanup();

		//
		// The service is no longer connected
		//
		TVShell.ConnectionManager.ServiceState = Service_LoggedOff;

		// Hangup
		TVShell.ConnectionManager.WANDisconnect();
		TVShell.ConnectionManager.LANDisconnect();

		// Stop audio.
		StopDialingMusic();
		DeviceControl.StopPlayingSound();
		
		// Remove the active page
		TVShell.URL = "msntv:/Shell/PowerOff.html";

		// Clear the non-persistent service list
		TVShell.BuiltinServiceList.Clear();

		// Turn off the screen saver and keep it from starting while
		// we are off.
		TVShell.ScreenSaver.Stop();
		TVShell.ScreenSaver.Enable = false;

		// Turn off the display
		DeviceControl.TVEncoder.OutputEnable = false;

		// Remember power state
		TVShell.Init.PowerState = PowerState_Off;
		TVShell.Init.Save();

		var BootROM = new ActiveXObject("MSNTV.BootRom");

		BootROM.Read();
		BootROM.PowerOnState = false;
		BootROM.Flush();

		PowerOffWhenComplete(0);
	}

	//
	// OnBeforeAuthorizationChange fires before user authorization is about to change
	//
	function OnBeforeAuthorizationChange(User)
	{
		TVShell.Message("Shell.html: OnBeforeAuthorizationChange");
		if(User.IsAuthorized)
		   mainPanel.History.Save();
	}

	//
	// OnAuthorizationChange fires when the state of user authorization changes
	//
	function OnAuthorizationChange(User)
	{
		TVShell.Message("Shell.html: OnAuthorizationChange");

		if (User.IsAuthorized) {
			AddUserAuthorizedPanels(PanelManager);
			mainPanel.History.Load();
			mainPanel.ClearTravelLog();
			mainPanel.NoBackToMe = true;
			TVShell.ActiveServiceList = User.ServiceList;
			LoginIMTimeoutID = setTimeout("LoginIM()", 30000);
		} 
		else {
			TVShell.MeteringManager.Stop();
			TVShell.PolicyManager.Cleanup();
			TVShell.LoginManager.Cleanup();
			RemoveUserAuthorizedPanels(PanelManager);
			TVShell.ActiveServiceList = TVShell.ServiceList;
		}
	}

    function OnUserAdded(User) 
    {
		var rom = new ActiveXObject("MSNTV.BootRom");
		rom.Read();
		var fdate = rom.FirstUseDate;
		if (fdate == 0) {
            TVShell.Message("OnUserAdded: setting first time use");  		
            // 0 -> let bootrom object calculate the time since 1970
            rom.FirstUseDate = 0;  
            rom.Flush();
    	}
    }

	function OnServiceStateChange(NewState, OldState)
	{
		TVShell.Message("Service state: "+NewState);
		
		
		// Give the ConnectionManager a chance to see the event
		ProviderServiceState(NewState);
	
		// If we are powering off or on, then don't change the page
		if (!TVShell.IsOn)
			return;

		if ( TVShell.ConnectionManager.WANCause == "FullUpdate" )
			return;
			
		if (NewState == Service_Authorized) {
			//
			// preload IE cache
			//
			TVShell.LoadPersistentInternetCache();
			PanelManager.Show("main");
		} 
		else if (NewState == Service_ReSignIn) {
			// If "ReSignIn" is set before a user has been authorized, treat it as a "retry" and don't clear the current user
			if (TVShell.UserManager.CurrentUser && TVShell.UserManager.CurrentUser.IsAuthorized)
				TVShell.UserManager.ClearCurrentUser();
			GotoSignOn();
			PanelManager.Show("main");
			playedHomeBrandSound = false;
		}
	}

	//
	// OnWANTimer - Periodically check for user activity and maybe disconnect
	//
	function OnWANIdleTimer()
	{
		if (TVShell.ConnectionManager.WANState == ConnectState_Connected) {
			//
			// No timeout for Ethernet
			//
			if (TVShell.ConnectionManager.WANProvider == BYOAEthernetProviderName)
				return;

			//
			// Ten minute timeout for modems, except for special cases
			//
			var MaxIdleTime = 10 * 60;

			//
			// Check if the WMP panel is showing and increase the
			// timeout if it is.
			//
			var wmp = PanelManager.Item(mediapanel.name);
			if (wmp && wmp.State == PanelState_Showing) {
				var parentWindow = wmp.Document.parentWindow;
				var playState = parentWindow.currentPlayState;	
				if (playState == parentWindow.MpPlaying || playState == parentWindow.MpScanForward || playState == parentWindow.MpScanReverse) {
					MaxIdleTime = 30 * 60; // 30 minutes

					//
					// If we get close to the limit, then put up an alert
					//
					if (TVShell.IdleTime > MaxIdleTime-30) {
						if (!PanelManager.Item(idlewarnpanel.name)) {
							AddPanel(PanelManager, idlewarnpanel);
							PanelManager.Show(idlewarnpanel.name);
							TVShell.ScreenSaver.UserActive(); // Wakeup screen saver
						}
					}
				}
			}

			//
			// If we are out of the warning zone, then make sure the warning is off
			//
			if (TVShell.IdleTime < MaxIdleTime-30)
				RemovePanel(idlewarnpanel.name);

			if (TVShell.IdleTime > MaxIdleTime) {
				TVShell.ConnectionManager.WANAdapter.ErrorCode = ConnectError_ConnectedTimeOut;
				return;
			}

			// Re-check after five seconds
			setTimeout(OnWANIdleTimer, 5000);
		}
	}

	//
	// OnLANTimer
	//
	function OnLANIdleTimer()
	{
		if (TVShell.ConnectionManager.LANState == ConnectState_Connected) {

			// Re-check after five seconds
			// setTimeout(OnWANIdleTimer, 5000);
		}
	}

	function StartDialingMusic(adapterType)
	{
		StopDialingMusic();

		// Play dialing followed by connecting sound loop, but only if we
		// do not have audible dialing on. For BB, go straight to connecting loop.
		if (TVShell.ConnectionManager.ModemAdapter.Settings.AudibleDialing)
			return;

		if (TVShell.ConnectionManager.ModemAdapter.Settings.AudibleDialingOverride == Override_On)
			return;

		if (TVShell.ConnectionManager.WANAdapter.Type == AdapterType_Modem) {
			DeviceControl.PlaySound("Dialing");
			connectingSoundID = setTimeout("DeviceControl.PlaySound('Connecting', SND_ASYNC|SND_LOOP);", 3000);
		}
		else {
			DeviceControl.PlaySound("Connecting", SND_ASYNC|SND_LOOP);
		}
	}

	function StopDialingMusic()
	{
		clearTimeout(connectingSoundID);
		connectingSoundID = 0;
	}

	function OnWANStateChange(ConnectCause, newState, newProgress)
	{
		TVShell.Message("WANStateChange("+ConnectCause+", "+newState+", "+newProgress+")");
		SetProgressPercent(newProgress);
		
		switch (newState) {
			case ConnectState_Disconnected:
				//
				// Turn the light off right away
				//
				DeviceControl.ConnectLED = LED_Off;

				StopDialingMusic();

				DeviceControl.PlaySound("Disconnect");

				var ErrorCode = TVShell.ConnectionManager.WANAdapter.ErrorCode;

				TVShell.Message("Shell.html - WAN Disconnected, ErrorCode="+ErrorCode);

				// Disconnect IM
				LogoffIM();

				//
				// Just in case the progress panel is up...
				//
				SetProgressText("Disconnected");

				// gives the user a chance to see the message before it's dismissed
				setTimeout(HideProgressPanel, 500);

				setTimeout(StopSlideShow, 50);

				RemoveOnlinePanels(PanelManager);

				TVShell.MeteringManager.Stop();

                // remove shares
	            if (HomeNetworking) {   
                    HomeNetworking.PowerOff();
	            }

				//
				// Don't redirect or show an error if we are not powered on
				//
				if (!TVShell.IsOn)
					return;

				//
				// If doing a nightly update, then just power off, whether or not there
				// was an error.
				//
				if (ConnectCause == "connection::nightly_login") {
					if (TVShell.PowerCause == "NightlyUpdate")
						TVShell.PowerOff();
					else
						GotoSignOn();
					return;
				}
				
				//
				// See if this is a provider-specific error case
				//
				if (ProviderError(ErrorCode))
					return;

				//
				// A Reconnect error means that the service is requesting that we hang up
				//
				if (ErrorCode == ConnectError_Reconnect) {
					TVShell.UserManager.SetCurrentUserIsAuthorized(false);
					GotoSignOn();
					return;
				}

				//
				// Check to see if we were fully connected to the service
				//
				if (TVShell.ConnectionManager.ServiceState == Service_Authorized) {
					var CurrentPanel = PanelManager.FocusedPanel;
					if (CurrentPanel && CurrentPanel.Name != "main" )
					{
						// hide any sliding panel that currently has the focus
						if ( CurrentPanel.Transition == SLIDING_PANEL_STYLE )
							PanelManager.Hide(CurrentPanel.Name);
					}

					//
					// If there was no error, then just display the reconnect panel
					//						
					if (ErrorCode == ConnectError_ConnectedTimeOut ||
						ErrorCode == ConnectError_NoError) {
						StopDownLoading();
						AddPanel(PanelManager, reconnectpanel);
						PanelManager.Show(reconnectpanel.name);
						return;
					}

					//
					// Otherwise, they get the connect error panel
					//
					var Errortxt;
					SetErrorMode(WANErrorMode);
					if (TVShell.ConnectionManager.WANAdapter.ErrorCode == ConnectError_IncomingCall) {
						Errortxt = "<P>Your "+ProductShortName+" was disconnected from the "+ServiceFullName+" because of an incoming phone call.</P>\
								<P>To reconnect to "+ServiceShortName+", choose <EM>Reconnect</EM>.</P>";
					} else {
						Errortxt = "<P>Your " + ProductShortName + " was disconnected from the " + ServiceFullName + ".</P><P>" + ShortErrorMessage() + "</P>";
					}

					if ( ConnectCause == "FullUpdate" ) {
						// don't login for full update
						return;
					}
					if (IsRegistered()  ) {
						var tmpRet = PanelManager.CustomMessageBox( Errortxt, "", "Sign Out;Reconnect", 1, "", false, MGX_ICON_WARNING, MGX_SIZE_LARGE );
						if ( tmpRet == 1 ) 
							setTimeout( 'LoginToService("connection::reconnect");' , 10 );
						else
							TVShell.ConnectionManager.ServiceState = Service_ReSignIn; // default
					}
					else {
						var tmpRet = PanelManager.CustomMessageBox( Errortxt, "", "Reconnect", 0, "", false, MGX_ICON_WARNING, MGX_SIZE_LARGE );
						if ( tmpRet == 0 ) 
							setTimeout( 'LoginToService("connection::reconnect");' , 10 );
					}

					return;
				} else if (ErrorCode == ConnectError_ConnectedTimeOut) {
					ErrorCode = ConnectError_NoError;
					if (IsRegistered() && ConnectCause != "FullUpdate") {
						// timed out on the update offer so go back to the sign-on page
						GotoSignOn();
					} else {
						// timed out on the sign-in screen
						break;
					}
				}

				//
				// If we disconnected with no error before we were authorized, that's
				// probably because the user hit the stop button.
				//
				if (ErrorCode == ConnectError_NoError)
					break;

				//
				// Present different errors depending on whether this is before or after
				// registration
				//
				if (IsRegistered())
					TVShell.URL = "msntv:/Connecting/ConnectError.html";
				else
					TVShell.URL = "msntv:/Registration/pages/ConnectError.html";
				break;

			case ConnectState_Connecting:
				DeviceControl.ConnectLED = LED_BlinkSlow;

				if (TVShell.ConnectionManager.WANAdapter.Type == AdapterType_Modem) {
					if (newProgress < 30) {
						SetProgressText(PROGRESS_PLEASE_WAIT + "Preparing to dial...");
					} else {
						SetProgressText(PROGRESS_PLEASE_WAIT + "Dialing " + GetDialedPhoneNumber());
					}
				} else {
					SetProgressText(PROGRESS_PLEASE_WAIT + "Connecting...");
				}
				if (newProgress == 0 && ConnectCause != "FullUpdate") {
					StartDialingMusic();
				}
				break;

			case ConnectState_Disconnecting:
				SetProgressText(PROGRESS_PLEASE_WAIT + "Disconnecting...");
				break;
				
			case ConnectState_Connected:
				TVShell.Message("Shell.html - WAN Connected");
				DeviceControl.ConnectLED = LED_On;

				OnWANIdleTimer();

				if (ConnectCause == "FullUpdate" ) {
					HideProgressPanel();
				}
				if (ConnectCause == "connection::nightly_login")
					HideProgressPanel();
				else
					SetProgressText(PROGRESS_PLEASE_WAIT + "Authenticating...");

				if (TVShell.ConnectionManager.WANAdapter.Type == AdapterType_Modem) {
					TVShell.Message("Modulation:" + TVShell.ConnectionManager.ModemAdapter.Settings.Modulation);
					TVShell.Message("TX/RX Rates:" + TVShell.ConnectionManager.ModemAdapter.Settings.TX_RXRates);
					TVShell.Message("Error Control:" + TVShell.ConnectionManager.ModemAdapter.Settings.ErrorControl);
					TVShell.Message("Compression:" + TVShell.ConnectionManager.ModemAdapter.Settings.Compression);
				}

  				// The proxy is disabled for dialup.  If the service wants us to have 
				// a proxy for dialup it can turn it on later.
				TVShell.ConnectionManager.HTTPProxy.ApplySettings();

				if (ConnectCause == "FullUpdate" ) {
					break;
				}
				StartServicePanel(ConnectCause, PanelManager);

				if (ConnectCause == "connection::reconnect") {
					var CurrentUser = TVShell.UserManager.CurrentUser;
					if (CurrentUser != null && CurrentUser.IsAuthorized) {
						var Messenger = CurrentUser.Messenger;
						if (Messenger != null) {
							var EMail= CurrentUser.EMail;
							if ((Messenger.LocalState == MSTATE_OFFLINE || Messenger.LocalState == MSTATE_UNKNOWN) && Messenger.LogoffReason == MLOGOFFREASON_NETWORKDOWN && EMail != "") {
								Messenger.LogoffReason = MLOGOFFREASON_UNKNOWN;
								Messenger.Logon(EMail, Messenger.Services.PrimaryService);
							}
						}
					}
					StopDialingMusic();
					DeviceControl.StopPlayingSound();
				}
				break;
		}
	}

	function StopWANConnecting()
	{
		SetProgressStopFunction(null);
		TVShell.ConnectionManager.WANDisconnect();
	}
	
	//
	// This is fired at the beginning of a WAN connection, before the connection is established
	//
	function OnWANConnect(ConnectCause)
	{
		TVShell.Message("Shell::OnWANConnect("+ConnectCause+")");

		//
		// Take down any reconnect panel right away.  It doesn't hurt if it was not
		// already up.
		//
		RemovePanel(reconnectpanel.name);

		if ( ConnectCause == "FullUpdate" ) {
			ShowProgressPanel();
			SetProgressText(PROGRESS_PLEASE_WAIT + "Connecting...");
		}
		if (TVShell.ConnectionManager.WANState == ConnectState_Connected) {
			//
			// We may have already been connected, but not authorized (e.g., we
			// were on the switch user page).  If so, then we don't need to connect,
			// but we may need to login again.
			//
			
			if (TVShell.ConnectionManager.ServiceState != Service_Authorized) {
				ShowProgressPanel();
				SetProgressText(PROGRESS_PLEASE_WAIT + "Authenticating...");
				StartServicePanel(ConnectCause, PanelManager);
			}
		} else {
			//
			// Verify that all of our settings are okay before we attempt to connect
			//
			VerifyProviderSetup();

			// If narrowband clear proxy settings if not reconnecting 
			if (TVShell.ConnectionManager.WANAdapter.Type == AdapterType_Modem && 
				TVShell.ConnectionManager.ServiceState != Service_Authorized) {		
				ClearHTTPProxySettings();
			}

			//
			// If we did not encounter an error while verifying the provider setup,
			// then start the progress panel.
			//
			if (TVShell.ConnectionManager.WANAdapter.ErrorCode == ConnectError_NoError) {
				ShowProgressPanel();
				SetProgressStopFunction(StopWANConnecting);
			}
		}
	}

	function StopLANConnecting()
	{
		SetProgressStopFunction(null);
		TVShell.ConnectionManager.LANDisconnect();
	}
	
	//
	// This is fired at the beginning of a LAN connection, before the connection is established
	//
	function OnLANConnect(ConnectCause)
	{
		TVShell.Message("Shell::OnLANConnect("+ConnectCause+")");

		switch (TVShell.ConnectionManager.LANState) {
			case ConnectState_Disconnected:
				//
				// Verify that all of our settings are okay before we attempt to connect
				//
				VerifyLANProviderSetup();

				//
				// If we did not encounter an error while verifying the provider setup,
				// and we have the right cause, then start the progress panel.
				//
				if (TVShell.ConnectionManager.LANAdapter.ErrorCode != ConnectError_NoError)
					return;

				// Fall through...

			case ConnectState_Connecting:
				if (ConnectCause == "LAN::ApplySettings" || ConnectCause == "LAN::Goto") {
					SetProgressPercent(10);
					SetProgressText("Connecting...");
					SetProgressStopFunction(StopLANConnecting);
					ShowProgressPanel();
				}
				break;

			case ConnectState_Disconnecting:
				break;

			case ConnectState_Connected:
				var entry = TVShell.ServiceList(ConnectCause);

				if (entry) {
					TVShell.ServiceList.Remove(ConnectCause);
					if (entry.URL && mainPanel && mainPanel.Document) {
						TVShell.Message("OnLANConnect: main.Document.location="+entry.URL);
						mainPanel.Document.location = entry.URL;
					}
				}

				TVShell.ConnectionManager.LANCause = "LAN::Reconnect";
				break;
		}
	}

	//
	// Timeout called whenever the LAN connection fails
	//
	function LANReconnect()
	{
		if (!TVShell.IsOn)
			return;

		if (TVShell.ConnectionManager.LANState == ConnectState_Disconnected) 
			TVShell.ConnectionManager.LANConnect(TVShell.ConnectionManager.LANCause);
	
	}

	function OnLANStateChange(ConnectCause, newState, newProgress)
	{
		//TVShell.Message("TVShell LANStateChange("+ConnectCause+", "+newState+", "+newProgress+")");
		
		if (ConnectCause == "LAN::ApplySettings" || ConnectCause == "LAN::Goto")
			SetProgressPercent(newProgress);
		
		switch (newState) {
			case ConnectState_Disconnected:
				var ErrorCode = TVShell.ConnectionManager.LANAdapter.ErrorCode;

				if (ErrorCode != ConnectError_NoLine) // Don't fill up log unnecessarily
					TVShell.Message("Shell.html - LAN Disconnected, ErrorCode="+ErrorCode);

				if (ErrorCode == ConnectError_Reconnect) {
					setTimeout("TVShell.ConnectionManager.LANConnect(\""+ConnectCause+"\");",  100);
					return;
				}

				if (ConnectCause == "LAN::ApplySettings" || ConnectCause == "LAN::Goto") {
					SetProgressText("Disconnected");

					// gives the user a chance to see the message before it's dismissed
					setTimeout(HideProgressPanel, 500);
				}

				HomeNetworking.StopUPNP();

				//
				// Don't redirect or show an error if we are not powered on
				//
				if (!TVShell.IsOn)
					return false;

				//
				// See if this is a provider-specific error case
				//
				//if (LANProviderError(ErrorCode))
				//	return;

				if (ErrorCode != ConnectError_NoError && ConnectCause == "LAN::ApplySettings") {

					var Errortxt = "<P>Your " + ProductShortName + " was ";
					var LANShortName;

					SetErrorMode(LANErrorMode);

					if (TVShell.ConnectionManager.LANAdapter ==
														TVShell.ConnectionManager.WirelessAdapter)
						LANShortName = "wireless network";
					else
						LANShortName = "local network";

					Errortxt += "unable to connect to ";

					Errortxt += "the "+LANShortName;
					Errortxt += ".</P><P>";
					Errortxt += ShortErrorMessage() + "</P>";

					var UserResponse = PanelManager.CustomMessageBox( Errortxt, "", "Done",
													0, "", false, MGX_ICON_WARNING, MGX_SIZE_LARGE);
				}

				if (ErrorCode != ConnectError_NoError && ConnectCause == "LAN::Goto") {
					TVShell.URL = "msntv:/Connecting/ConnectError.html?ErrorMode=LAN";
				}

				//
				// If we get a LAN error, then silently try and reconnect after
				// a few seconds
				//
				TVShell.ConnectionManager.LANCause = "LAN::Reconnect";
				setTimeout("LANReconnect();", 5 * 1000);

				break;

			case ConnectState_Connecting:
				if (ConnectCause == "LAN::ApplySettings" || ConnectCause == "LAN::Goto")
					SetProgressText(PROGRESS_PLEASE_WAIT + "Connecting...");
				break;

			case ConnectState_Disconnecting:
				if (ConnectCause == "LAN::ApplySettings" || ConnectCause == "LAN::Goto")
					SetProgressText(PROGRESS_PLEASE_WAIT + "Disconnecting...");
				break;
				
			case ConnectState_Connected:
				TVShell.Message("Shell.html - LAN Connected ");

				
				if (ConnectCause == "LAN::ApplySettings") {
					SetProgressText("Connected");
					setTimeout("HideProgressPanel();", 2 * 1000);
					TVShell.ConnectionManager.LANCause = "LAN::Reconnect";
					
					var Errortxt = "<P>Your " + ProductShortName;
					var LANShortName;

					SetErrorMode(LANErrorMode);

					if (TVShell.ConnectionManager.LANAdapter ==
													TVShell.ConnectionManager.WirelessAdapter)
						LANShortName = "wireless network";
					else
						LANShortName = "local network";

					Errortxt += " successfully connected to ";

					Errortxt += "the "+LANShortName;
					Errortxt += ".</P><P>";

					var UserResponse = PanelManager.CustomMessageBox( Errortxt, "", "Done",
												0, "", false, MGX_ICON_INFO, MGX_SIZE_LARGE);
				}

				var entry = TVShell.ServiceList(ConnectCause);

				if (entry) {
					TVShell.ServiceList.Remove(ConnectCause);
					if (entry.URL && mainPanel && mainPanel.Document) {
						TVShell.Message("OnLANState: setting main.Document.location to "+entry.URL);
						mainPanel.Document.location = entry.URL;
					}
				}

				TVShell.ConnectionManager.LANCause = "LAN::Reconnect";

				OnLANIdleTimer();
				HomeNetworking.StartUPNP(TVShell.StorageManager);
				break;
		}
		return false;
	}

	function OnSecretCode(secretCode)
	{
		TVShell.Message("Shell.html: processing SecretCode " + secretCode);
		switch (secretCode) {
			case 6145539:
				TVShell.EventLog.CrashLogMgr.CrashTheSystem();
				break;
			case 32768:
				TVShell.DeleteAllFilesAndReboot();
				break;
			case 411:
			{
				var entry = TVShell.BuiltinServiceList.Add("RunOnce");
				entry.URL = "msntv:/Settings/System/System.html";
				break;
			}
			case 93288:
			{
				var entry = TVShell.BuiltinServiceList.Add("RunOnce");
				entry.URL = "msntv:/tvshell/Register.html";
				break;
			}
			case 10000:
			{
				var entry = TVShell.BuiltinServiceList.Add("RunOnce");
				entry.URL = "msntv:/Connecting/AboutToSynch.html";
				TVShell.PowerOn("NightlyUpdate");
				break;
			}
			case 7264:
				TVShell.Message("Shell.html: secret code clear tellyscript, clearing phone book of the LocalPOP connector");
				for(var i = 0; i < TVShell.ConnectionManager.MSNIAManager.Connectors.Count; i++) {
					var connector = TVShell.ConnectionManager.MSNIAManager.Connectors.Item(i);
					if(connector.Name == LocalConnectorName) {
						connector.Phonebook.Clear();
					}
				}
				
				TVShell.ConnectionManager.Save();
				break;			
				
				// advanced wireless settings
			case 80211:
			{
				var entry = TVShell.BuiltinServiceList.Add("RunOnce");
				entry.URL = "msntv:/Settings/Network/WirelessAdvanced.html";
				break;
			}
				// bootrom secret codes		
			case 2021:
			case 8086:
			{
				var rom = new ActiveXObject("MSNTV.BootRom");

				TVShell.Message("Shell.html: bootrom SecretCode " + secretCode);
				rom.Read();
				rom.SecretCode = secretCode;
				rom.Flush();
				
				TVShell.Reboot();
				break;
			}
				
			case 3932397:
			
			{
				TVShell.Message("Start Update loop test");


				
				var service = TVShell.ServiceList("connection::login");
				var syncURL = "sync-sg1.trusted.msntv.msn.com/syncserver/";
				
				
				if ( service != null && service.Description != "Production" ) {
					syncURL = service.URL;
					var httpPrefix = "http://";
					var httpsPrefix = "https://";
					var hwPrefix = "headwaiter.";
					if ( syncURL.indexOf(httpPrefix) == 0 ) {
						syncURL = syncURL.substring(httpPrefix.length,syncURL.length);
					}
					if ( syncURL.indexOf(httpsPrefix) == 0 ) {
						syncURL = syncURL.substring(httpsPrefix.length,syncURL.length);
					}
					if ( syncURL.indexOf(hwPrefix) == 0 ) {
						syncURL = syncURL.substring(hwPrefix.length,syncURL.length);
					}
					if ( syncURL.indexOf("/") > 0  ) {
						syncURL = syncURL.substring(0,syncURL.indexOf("/"));
					}
					if ( syncURL == "trusted.msntv.msn.com" ) {
						syncURL = "Sync-sg1." + syncURL;
					} else {
						syncURL = "Sync-" + syncURL;
					}
					syncURL += "/syncserver/";
				}
				TVShell.Message("Set update loop URL to " + syncURL);
				var PersistentProperties = TVShell.Property("Persistent/");
				PersistentProperties.Add("UpdateLoopTestMode", 1);
				PersistentProperties.Add("UpdateLoopURL", syncURL);
				PersistentProperties.Add("UpdateLoopIteration",0); 
				PersistentProperties.Save();

				break;
			}
			
				
			default:
				TVShell.Message("Shell.html: ignoring unknown SecretCode " + secretCode);
				break;
		}
	}

    function OnURLMONDialog(panelname, actionCode, info)
	{
       if (panelname=="main")
	   {
	       var urlmonuipanel = new Panel("URLMONUI", "msntv:/tvshell/urlmonui.htm",
								  SYSTEM_PANEL_TYPE, POPUP_PANEL_STYLE,80,0,false);
           urlmonuipanel.start = new Rectangle(safeLeft+(safeWidth-300)/2, (screenHeight - 360) / 2, 300, 240);
		   urlmonuipanel.modal = true;
		   AddPanel(PanelManager, urlmonuipanel);
	       PanelManager.Item("URLMONUI").UserStrData=info;
	       PanelManager.Show("URLMONUI");
	   }
	     
	}

    function OnWININETDialog(panelname, hInternet,errorCode, errorData,info)
	{
	   var wininetuipanel = new Panel("WININETUI", "msntv:/tvshell/wininetui.htm",
							  SYSTEM_PANEL_TYPE, POPUP_PANEL_STYLE,80,0,false);
	   wininetuipanel.start = new Rectangle(safeLeft+(safeWidth-420)/2, (screenHeight - 310) / 2, 420, 310);
	   wininetuipanel.modal = true;
	   AddPanel(PanelManager, wininetuipanel);

	   TVShell.Message("Internet handle is "+ hInternet);

	   PanelManager.Item("WININETUI").UserStrData=errorCode.toString(10)+","+errorData.toString(10);
	   PanelManager.Item("WININETUI").UserIntData=hInternet;

	   PanelManager.Show("WININETUI");
	}

    function OnPrintCommand(panelname)
	{
   	   GotoPrint();
  	}
    
	function OnNavigateError(panelName, statusCode, url)
	{
		//
		// See ErrorCodes.js for possible statusCode values
		//
		TVShell.Message("OnNavigateError: Received error code " + statusCode + " from panel '" + panelName + "' for URL: " + url);

		var errorHandled = false;
		
		if (TVShell.ConnectionManager.WANAdapter.Type == AdapterType_Modem) {
			var proxy = TVShell.ConnectionManager.HTTPProxy;
			if (proxy.Enabled) {
				if (proxy.Verify() != ConnectError_NoError) {
					ClearHTTPProxySettings();
					errorHandled = true;
					TVShell.ConnectionManager.WANAdapter.ErrorCode = ConnectError_ProxyServerNotFound;
				}
			}
		}
		
		//
		// If the service panel gets an error, then disconnect
		//
		if (panelName == servicepanel.name) {
			if (statusCode >= 400 && statusCode < 600)
				TVShell.ConnectionManager.WANAdapter.ErrorCode = ConnectError_LoginError;
			else
				TVShell.ConnectionManager.WANAdapter.ErrorCode = ConnectError_ServiceUnreachable;
		}

		else if(!errorHandled && panelName == mainPanel.name)
		{
		    mainPanel.UserIntData=statusCode;
			mainPanel.UserStrData=url;
		    mainPanel.GotoURL("msntv:/TVShell/errors.htm");
			OnNavigateComplete2(panelName, url);
		}
	}

	function OnDocumentComplete(panelName)
	{
		if (panelName == servicepanel.name) {
			TVShell.Message("OnDocumentComplete: " + panelName);

			var panel = PanelManager.Item(panelName);
			if (panel && panel.Document && panel.Document.body && panel.Document.body.innerText)
			{	// A problem has occurred; show the page in the main panel
				TVShell.Message("ServicePanel document has illegal content! Redirecting it to the main panel...");
				var src = PanelManager.Item(servicepanel.name).HTMLSource;
				mainPanel.Document.open();
				mainPanel.Document.write(src);
				mainPanel.Document.close();
				PanelManager.Show("main");
			}
			panel = null;
		}

		if (panelName == "main")
		{
			var playHomeBrand = false;
			// Login Messenger
			if (TVShell.UserManager.CurrentUser)
			{
				var home = TVShell.UserManager.CurrentUser.ServiceList.Item("home::home");
				var mainUrl = mainPanel.URL;
				if (home != null && mainUrl.indexOf(home.URL) >= 0)
				{
					LoginIM();
					playHomeBrand = true;
				}
			}

			// Until HomePage plays sound, stop connecting sound here unless connecting.
			// The connecting case occurs when the user selects "connect" from the Access Numbers page
			// or from the Have You Moved page.
			if (TVShell.ConnectionManager.WANState != ConnectState_Connecting) {
				StopDialingMusic();
				if ( !playedHomeBrandSound && playHomeBrand )
				{
					DeviceControl.PlaySound("MSN_Home_brand");
					playedHomeBrandSound = true;
				}
				else
					DeviceControl.StopPlayingSound();
			}
		}

		if (panelName == "statusbar") {
			var currentUser = TVShell.UserManager.CurrentUser;

			if (currentUser && currentUser.IsAuthorized) {
				AddUserAuthorizedPanels2(PanelManager);
			}
		}
	}

	var Memory_Ok      = 0;
	var Memory_Warning = 1;
	var Memory_Low     = 2;
	var Memory_Out     = 3;

	TVShell.EventLog.SystemMonitor.SetMemoryThresholds(2*1024*1024, 512 * 1024);

	function OnMemoryStateChange(newstate)
	{
		switch (newstate) {
			case Memory_Ok:
				TVShell.Message("Shell: OnMemoryStateChange -> ok");
				break;
			case Memory_Warning:
				TVShell.Message("Shell: OnMemoryStateChange -> warning");
				StopLoadingMain();
				break;
			case Memory_Low:
				TVShell.Message("Shell: OnMemoryStateChange -> low");
				TVShell.URL = "msntv:/Shell/OutOfMemory.html";
				break;
			case Memory_Out:
				TVShell.Message("Shell: OnMemoryStateChange -> out");
				break;
		}
	}
	
	
	function OnDeviceAdd(StorageDevice)
	{
		// Only react to mounted, removable, devices
		if (!StorageDevice || !StorageDevice.Removable || !StorageDevice.Mounted || StorageDevice.IsNetwork)
			return;

		// Must be registered.
		if (!IsRegistered()) {
			return;
		}
		
		TVShell.Message("Shell.html: Device added: "+StorageDevice.VolumeName);
		if(TVShell.Patcher.isUpdate(StorageDevice.VolumeName) && ValidXML("file:" + TVShell.Patcher.AutoUpdateXMLPath))
		{
			if(!TVShell.IsOn)
				return;				
			
	  		InitPatch(StorageDevice);
	  		return;
		}
		else
		{
			TVShell.Message("No patch found");
			
		}


		TVShell.ScreenSaver.UserActive(); // Wakeup screen saver
		
		if ( !ReadSmartNetKey() ) {

			if (IsMainPanelOnPage("msntv:/Photo/MediaHelp.html"))
				return;
			if (IsMainPanelOnPage("msntv:/Photo/PhotoHome.html"))
				return;
			if (IsMainPanelOnPage("msntv:/Music/MusicHome.html"))
				return;
			if (IsMainPanelOnPage("msntv:/Video/VideoHome.html"))
				return;
			if (IsPhotoPickerPanelVisible())
				return;

			if (IsMainPanelInWriteMail()) {
				var message = "<p>You've inserted a USB storage device.</p>" +
							  "<p>Choose <em>OK</em>, and then choose <em>Insert Photos</em> to add pictures to this e-mail message.</p>";
				PanelManager.CustomMessageBox(message, "", "OK", 0, "", true, MGX_ICON_INFO, 0);
			}
			else {
				var message = "<p>You've inserted a USB storage device.</p>" +
							  "<p>Choose <em>Photos</em>, <em>Music</em>, or <em>Videos</em> if you would like to view or listen to this media now.</p>";
				var retVal = PanelManager.CustomMessageBox(message, "", "Photos;Music;Videos;Done", 3, "", true, MGX_ICON_INFO, 0);
				var target = null;
				if (retVal==0)
					target = "Photo";
				else if(retVal==1)
					target = "Music";
				else if(retVal==2)
					target = "Video";

				if (target) {
					if (canAccessOfflineApp()) {
						mainPanel.GotoURL("msntv:/" + target + "/Viewer.html?location=0&StorageDeviceVN=" + escape(StorageDevice.VolumeName) + "&jump=true");
					}
					else {
						NotProvisionedMessageBox();
					}
				}
			}
		}
	}

	function OnDeviceRemove(StorageDevice)
	{
		// Only react to removable devices
		if (!StorageDevice || !StorageDevice.Removable || !StorageDevice.Mounted || StorageDevice.IsNetwork)
			return;

		TVShell.Message("Shell.html: Device removed: "+StorageDevice.VolumeName);
		
		TVShell.PhotoManager.ClearThumbnailRequestQueue();
		TVShell.PhotoManager.ClearImageResizeRequestQueue();
		TVShell.PhotoManager.RemovePathFromImageList(StorageDevice.VolumeName+"\\");


		// show and alert message only if currently on writemail page
		if(!IsMainPanelInWriteMail())
			return;
	
		var message = "You removed your memory card or reader.  You must reconnect the card to send photos from it with this email."
        PanelManager.CustomMessageBox(message,"","OK",0,"", false, 0x30, 1);
	}

	function IsMainPanelOnPage(pageURL)
	{
		if(!pageURL)	
			return false;
		
		pageURL = pageURL.toLowerCase();	
			
		var currentURL = mainPanel.URL;	
		currentURL = currentURL.toLowerCase();	
		
		var retVal = (currentURL.indexOf(pageURL) == 0) ? true : false;	
		return retVal;
	}
	
	function IsMainPanelInWriteMail()
	{	
		var CurrentUser	= TVShell.UserManager.CurrentUser;
		if(!CurrentUser)
			return false;
		
		var writemailURL = "";
		var writemailService   = CurrentUser.ServiceList("mail::writemail");
		if(writemailService)
			writemailURL  = writemailService.URL;
		
		return(IsMainPanelOnPage(writemailURL));
	}
	

	function IsMainPanelInDocViewer()
	{	
		var currentURL = mainPanel.URL;	
		currentURL = currentURL.toLowerCase();	
		var retVal = (currentURL.indexOf("msntv:/docviewer/docviewer.htm") == 0) ? true : false;
		return retVal;
	}

	function IsMainPanelInPhotoViewer()
	{	
		var currentURL = mainPanel.URL;	
		currentURL = currentURL.toLowerCase();	
		var retVal = (currentURL.indexOf("msntv:/photo/viewer.html") == 0) ? true : false;
		return retVal;
	}

	function IsPhotoPickerPanelVisible()
	{	
		var photoPickerPanel = PanelManager.Item("PhotoPickerPanel");						
		if( photoPickerPanel && photoPickerPanel.State == 0)
			return true;
		else
			return false;
	}

	function IsMainPanelInMSNVideoAndShouldBypassGoBack()
	{	
		var CurrentUser = TVShell.UserManager.CurrentUser;
		if (CurrentUser) {
			var MSNVideoEntry = CurrentUser.ServiceList.Item("home::videoplus");
			if (MSNVideoEntry && MSNVideoEntry.URL) {
				var MSNVideoPath = MSNVideoEntry.URL;
				var currentURL = mainPanel.URL.toLowerCase();
					
				MSNVideoPath = MSNVideoPath.substring(0, MSNVideoPath.lastIndexOf("/")).toLowerCase();
				if (currentURL.indexOf(MSNVideoPath) == 0) {
					if (typeof(mainPanel.Document.GoBack) != "undefined" && mainPanel.Document.GoBack() == true)
						return true;
				}
			}
		}
		return false;
	}

	// check for a diploma before showing this panel, return true if a diploma is displayed
	function diplomaDisplayed( panelName , message )
	{
		var CurrentUser = TVShell.UserManager.CurrentUser;
		if ( CurrentUser == null ) return false;
		if ( panelName == "impanel" )
		{
			if ( ( CurrentUser.DiplomaSettings & MDIPLOMA_IM ) == 0 )
			{
				CurrentUser.DiplomaSettings = CurrentUser.DiplomaSettings | MDIPLOMA_IM;
				var url = GetPaneHelpURL( PH_diploma , 'MSNTV_DIPLOMA_Messenger.htm' ,"");
				PanelManager.Show('main');
				PanelManager.Item('main').GotoURL(url);
				return true;
			}
		}
		return false;
	}

	
	var rootFavURL, addFavURL;
	function OnServiceListKeyDown(ServiceEntry)
	{
		//TVShell.Message("OnServiceListKeyDown: "+ServiceEntry.name);		

		// Check offline provisioning
		if (ServiceEntry.ProvisioningRequired == true) {
			if (!IsRegistered()) {
				return;
			}
			if (canAccessOfflineApp() == false) {
				NotProvisionedMessageBox();
				return;
			}
		}
		//
		// Check if the current panel is marked "modal", in which case we leave it alone.
		//
		var CurrentPanel = PanelManager.FocusedPanel;
		var Modal = false;

		if (CurrentPanel && CurrentPanel.Modal)
			Modal = true;
		
		if (!Modal) {
			//
			// If the Service Entry has a panel, then show it
			//

			if (ServiceEntry.Panel != "") {
				if (ServiceEntry.Panel == "favoritespanel") {
					var favURL = PanelManager.Item('favoritespanel').URL;
					rootFavURL = favURL.substr(0, (favURL.indexOf("?") > 0)? favURL.indexOf("?") : favURL.length);
					addFavURL = rootFavURL + "?action=AddFavorite";
					if (ServiceEntry.Message == "add") {
						if (CurrentPanel.Name == "favoritespanel") {
							PanelManager.Hide("favoritespanel"); // dimiss favorites panel first
							if (favURL != addFavURL) {// if current favURL is not addFavURL
								setTimeout("PanelManager.Item('favoritespanel').GotoURL(addFavURL);",300); // set addFavURL to favorits Panel
								setTimeout("PanelManager.Show('favoritespanel');",600);// pop up favorites panel
							}
						} else {
							PanelManager.Item('favoritespanel').GotoURL(addFavURL); // set addFavURL to favorits Panel
							setTimeout("PanelManager.Show('favoritespanel');",300);// pop up favorites panel
						}
					} else {
						if (CurrentPanel.Name == "favoritespanel" && favURL == addFavURL) {
							PanelManager.Hide("favoritespanel"); // dimiss add favorite panel first
							setTimeout("PanelManager.Item('favoritespanel').GotoURL(rootFavURL);",300); // set rootFavURL to favorits Panel
							setTimeout("PanelManager.Show('favoritespanel');",600);// pop up favorites panel
						} else {
							PanelManager.TogglePanel(ServiceEntry.Panel, ServiceEntry.Message);
						}
					}
				}
				else {
					if ( !diplomaDisplayed( ServiceEntry.Panel, ServiceEntry.Message ) )
						PanelManager.TogglePanel(ServiceEntry.Panel, ServiceEntry.Message);
				}
				return;
			}

            if(ServiceEntry.Name=="browser::print")
			{
			  TVShell.Message("about to toggle panel");
			  if(PanelManager.FocusedPanel.Name=="printsettings")
				PanelManager.TogglePanel("printsettings", "");
			  else if (IsMainPanelInDocViewer() && !mainPanel.Document.parentWindow.isDocumentLoaded)
			  {
				TVShell.Message("document not loaded ");
				TVShell.DeviceControl.PlaySound("Page_Boundary");
				return;
			  }
			  else if(IsMainPanelInPhotoViewer() && NoPhotoSelected())
			  {

				  // if there is already another modal dialog on, simply return and not show any 
				   // message box
				  if(PanelManager.ModalDlgOn)
					  return;

				  var content="<p>";
				  content+="<p>Please choose one or more photos.";
 				  PanelManager.CustomMessageBox(content,"No photo selected","OK",0,"", true)
				  return;
			  }			  
			  else if(PrinterAvailable())
			  {
			  	if(IsMainPanelInPhotoViewer() && PanelManager.FocusedPanel.Name=="main")
				  mainPanel.Document.ClickPrintButton();
				else
				  PanelManager.TogglePanel("printsettings", "");
			  }
			  else { 
				  // if there is already another modal dialog on, simply return and not show any 
				   // message box
				  if(PanelManager.ModalDlgOn)
					  return;

				  var content="<p><p>";
				  content+="<p>To print, you need to have a compatible printer connected to your "+ProductShortName+", and the printer must be turned on.";
 				  content+="<p>To see a list of printers that are compatible with "+ ServiceShortName +", choose <EM>See Printers List</EM>.";
 				  if(PanelManager.CustomMessageBox(content,"","See Printers List;OK;",1,"", true)==0){
				     PanelManager.Show("main");
					 PanelManager.Item('main').GotoURL(GetCompatPrinterListURL());

				  }
			  }
			  return;
			}
			//
			// If the entry has a URL, then send the main panel to it.
			//
			if (ServiceEntry.URL != "") {
				PanelManager.Show("main");
				TVShell.URL = ServiceEntry.URL;
				return;
			}

			//
			// Handle back/esc key entry in following priority order
			//		1. Dismiss Alert panel if visible
			//		2. Go back one page in focused panel if back key.
			//		3. Hide focused panel if not "main".
			//
			if (ServiceEntry.name == "browser::back" || ServiceEntry.name == "browser::esc") {
				var	alertPanel = PanelManager.Item("alert");

				if (alertPanel && alertPanel.State == PanelState_Showing) {
					PanelManager.Hide("alert");
				}
				else {
					var wentBack = false;
					var byPass = false;

					if ( CurrentPanel && CurrentPanel.Name == "main" )
					{
						if ( IsMainPanelInDocViewer() || IsMainPanelInMSNVideoAndShouldBypassGoBack() ) byPass = true;

					}

					if ( !byPass )
					{
						wentBack = ServiceEntry.name == "browser::back" ? PanelManager.GoBack() : false;
					}

					if (wentBack) {
						DeviceControl.PlaySound("Back");
					}
					else if (CurrentPanel && CurrentPanel.Name != "main" && CurrentPanel.Name != "mediapanel") {
							PanelManager.Hide(CurrentPanel.Name);
					}
				}
				return;
			}					

			if (ServiceEntry.name == "browser::showpopup") {
				if (lastSuppressedPopupURL != null && lastSuppressedPopupURL != "") {
					mainPanel.GotoURL(lastSuppressedPopupURL);
					return;
				}
			}

			//
			// If the entry is a favorite's shortcut, just return. Favorites.html will process this event 
			//
			if (ServiceEntry.name.substr(0,ServiceEntry.name.length-1) == "favorite::shortcut") {
				return;
			}

			//
			// Layout mode switching.
			//
			
			if (ServiceEntry.name == "TVLensMode") {
				TVShell.Message("TVLensMode");
				if(IsMainPanelInDocViewer())
				{
					var msg = "<P>To adjust your view of this document, choose the <EM>Text Size:</EM> (<EM>-</EM>) and (<EM>+</EM>) keys on your keyboard or the <EM>Zoom</EM> (<EM>-</EM>) and (<EM>+</EM>) buttons.</P>";
					msg += "<P>To make this document fit to the full width of your TV screen, choose <EM>Full&nbsp;Screen</EM>.</P>";
					PanelManager.CustomMessageBox(msg,"","OK",0,"", true);
					return;
				}

				var CurrentUser = TVShell.UserManager.CurrentUser;
				if (CurrentUser && (CurrentUser.DiplomaSettings & MDIPLOMA_PAGESIZE) == 0 && IsRegistered())
				{
					CurrentUser.DiplomaSettings = CurrentUser.DiplomaSettings | MDIPLOMA_PAGESIZE;
					var content = "<P>You pressed the <EM>Resize Page</EM> key.</P><P> If a Web page looks cramped, press <EM>Resize Page</EM> to expand it horizontally. Use the <EM>Left</EM> and <EM>Right Arrow</EM> keys to view the page.</P><P>All pages will remain expanded until you press <EM>Resize Page</EM> again.</P>";
					PanelManager.CustomMessageBox(content,"","OK",0,"", true, MGX_ICON_INFO);
				}

				var mode = PanelManager.LayoutMode;
				if (mode == 0)	// currently in wide mode
					DeviceControl.PlaySound("PageResizeForceFit"); 
				else
					DeviceControl.PlaySound("PageResizeWideView");

				PanelManager.LayoutMode = (mode > 0) ? 0 : 1;	
				setTimeout("PanelManager.Item('main').Relayout();", 1);	// allow SettingsChange event to propogate;
				return;
			}

			if (ServiceEntry.name == "TVLensModeTest") {
				var mode = PanelManager.LayoutMode;
				var modeNames = new Array();
				modeNames[0] = "Normal";
				modeNames[1] = "Force fit";
				modeNames[2] = "Force fit w/ hard minimum";
				var sound = "PageResizeWideView";
				var animation = "msntv:/Panels/Images/PageResizeOut.gif";
					
				if (++mode > 2) {
					mode = 0;
				}

				if (mode == 1) {
					sound = "PageResizeForceFit";
					animation = "msntv:/Panels/Images/PageResizeIn.gif";
				}

				PanelManager.LayoutMode = mode;
			    PanelManager.AnimationMessageBox("Layout mode is now " + modeNames[mode] + ".", animation, sound);
				setTimeout("PanelManager.Item('main').Relayout();", 1); // allow SettingsChange event to propogate;
				return;
			}

			if (ServiceEntry.name == "ZoomUp") {
				TVShell.Message("ZoomUp");
				if (IsPhotoPickerPanelVisible())
				{
					var photoPickerPanel = PanelManager.Item("PhotoPickerPanel");
					photoPickerPanel.Document.parentWindow.ZoomIn();
					return;
				}
				else if(IsMainPanelInDocViewer() || IsMainPanelInPhotoViewer())
				{
					mainPanel.Document.parentWindow.ZoomIn();
					return;
				}
				else
				{
					var CurrentUser = TVShell.UserManager.CurrentUser;
					if (CurrentUser && (CurrentUser.DiplomaSettings & MDIPLOMA_TEXTRESIZE) == 0 && IsRegistered())
					{
						CurrentUser.DiplomaSettings = CurrentUser.DiplomaSettings | MDIPLOMA_TEXTRESIZE;
						var content = "<P>You pressed a <EM>Text Size</EM> button.</P><P>Press the <EM></EM> button to make the text on Web pages smaller, or the <EM>+</EM> button to make it larger. (Press repeatedly if necessary.)</P>The size you selected will apply to all pages until you press a <EM>Text Size</EM> button again, or until you sign out.";
						PanelManager.CustomMessageBox(content,"","OK",0,"", true, MGX_ICON_INFO);
					}
					if (PanelManager.ZoomUp()) {
						DeviceControl.PlaySound("IncreaseTextSize"); 
					}
					else {
						DeviceControl.PlaySound("Page_Boundary"); 
					}
					return;
				}
			}
			if (ServiceEntry.name == "ZoomDown") {
				TVShell.Message("ZoomDown");
				if (IsPhotoPickerPanelVisible())
				{
					var photoPickerPanel = PanelManager.Item("PhotoPickerPanel");
					photoPickerPanel.Document.parentWindow.ZoomOut();
					return;
				}
				else if(IsMainPanelInDocViewer() || IsMainPanelInPhotoViewer())
				{
					mainPanel.Document.parentWindow.ZoomOut();
					return;
				}
				else
				{
					var CurrentUser = TVShell.UserManager.CurrentUser;
					if (CurrentUser && (CurrentUser.DiplomaSettings & MDIPLOMA_TEXTRESIZE) == 0 && IsRegistered())
					{
						CurrentUser.DiplomaSettings = CurrentUser.DiplomaSettings | MDIPLOMA_TEXTRESIZE;
						var content = "<P>You pressed a <EM>Text Size</EM> button.</P><P>Press the <EM></EM> button to make the text on Web pages smaller, or the <EM>+</EM> button to make it larger. (Press repeatedly if necessary.)</P>The size you selected will apply to all pages until you press a <EM>Text Size</EM> button again, or until you sign out.";
						PanelManager.CustomMessageBox(content,"","OK",0,"", true, MGX_ICON_INFO);
					}
					if (PanelManager.ZoomDown()) {
						DeviceControl.PlaySound("DecreaseTextSize"); 
					}
					else {
						DeviceControl.PlaySound("Page_Boundary"); 
					}
					return;
				}
			}

			if (ServiceEntry.name == "browser::print") {
				GotoPrint();
				return;
			}
			if (ServiceEntry.name == "CaptureScreen") {
				var fileName = window.prompt("Enter screen capture filename", "capture.bmp");

				if (fileName != "") {
					// Done as a timeout to allow screen updated after prompt panel is closed.
					setTimeout("TVShell.ThumbnailManager.CaptureScreenshot(null, '\\\\Hard Disk\\\\" + fileName + "');", 10);
				}
				return;
			}

			if (ServiceEntry.name == "ScreenSaver") {
				TVShell.Message("ScreenSaver");
				var ScreenSaverFileName = TVShell.PhotoManager.DevicePhotoPath;
				ScreenSaverFileName+="ScreenSaver.txt";
				var dstURL = "msntv:/Photo/SlideShow.html?startIndex=0&mode=ScreenSaver&tempAllFileList=" + ScreenSaverFileName;
				TVShell.URL = dstURL;
				return;
			}
		}

		// Bad news, either the current panel is modal, or the panel doesn't exist,
		// or the URL is empty.  Bonk.
		DeviceControl.PlaySound("Error");
	}

	function UpdateServiceHours()
	{
		var rom = new ActiveXObject("MSNTV.BootRom");
		rom.UpdateServiceHours();
	}
	
	function OnTimeout(taskScheduler, taskEntry)
	{
		if (taskEntry.Caller == "NightlyUpdate" && TVShell.ServiceList("connection::nightly_login"))
		{
			TVShell.Message("OnTimeout - " + taskEntry.Caller);
			if (!TVShell.IsOn || 
				(TVShell.IdleTime > (10*60) && (TVShell.UserManager.CurrentUser == null || !TVShell.UserManager.CurrentUser.IsAuthorized)))
			{
				if (!TVShell.IsOn) {
					var entry = TVShell.BuiltinServiceList.Add("RunOnce");
					entry.URL = "msntv:/Connecting/AboutToSynch.html";
					TVShell.PowerOn("NightlyUpdate");
				} else
					TVShell.URL = "msntv:/Connecting/AboutToSynch.html";

				TVShell.IdleTime = 0;
				TVShell.ScreenSaver.UserActive(); // Wakeup screen saver
			}
		}
		else {
			TVShell.Message("OnTimeout - " + taskEntry.Caller);
		}
	}

    function OnPrintDeviceAdd(NewPrinter)
	{

       // if there is already another modal dialog on, simply return and not show any 
	   // message box
       if(PanelManager.ModalDlgOn)
	      return;

	   var PEN_COLOR = 2;
	   var PEN_BLACK = 1;
	   var content="<p>";

	   var printername= ConditionalizePrinterName(NewPrinter.Manufacturer, NewPrinter.Model);

	   if(NewPrinter.Driver!="unsupported")
	   {
		  content+="<p>You have successfully connected an "+TVShell.Utilities.EscapeHTML(printername)
		           +" printer to your " + ProductShortName + ".";
		  content+="<p>You can print a page at any time by pressing the <EM>Print</EM> key on your keyboard.";
	      PanelManager.CustomMessageBox(content,"","OK",0,"", true, MGX_ICON_INFO)
		  
	   }
/*	   else if(NewPrinter.PCLCompatible==true) // not supported but PCL compatible
	   {
		 content+="<p>You have connected an "+TVShell.Utilities.EscapeHTML(mf)
		           +" " +TVShell.Utilities.EscapeHTML(model)+" printer to your " + ProductShortName + ".";
		 content+=" This printer is not supported by MSNTV. Please click <EM>Help </EM> to view all supported models.";
		 content+=" You can select OK to continue to use this printer. However you may have problems using this printer." ;
 		 var result=PanelManager.CustomMessageBox(content,"","Help;OK;Cancel",2,"", true);
         if(result==1)
		 {   
		     NewPrinter.Driver="pcl.dll";
		     PrintManager.SetCurrPrinter(NewPrinter.Port);
		 }
		 else if(result==0)
		 {
             TVShell.PanelManager.Item('main').GotoURL(GetCompatPrinterListURL());

		 }
	   }*/
	   else // not supported, not PCL compatible
	   {
          content+="The printer you connected is not supported by " + ServiceShortName +".";
	      content+="<p>To see a list of supported printers, choose <EM>See Printers List</EM>.";
 	      if(PanelManager.CustomMessageBox(content,"","See Printers List;OK;",1,"", true)==0)
		     PanelManager.Item('main').GotoURL(GetCompatPrinterListURL());

	   }

	}

	function LoginIM()
	{
		clearTimeout(LoginIMTimeoutID);
		LoginIMTimeoutID = 0;

		var CurrentUser = TVShell.UserManager.CurrentUser;
		if (CurrentUser != null && CurrentUser.ServiceList.Item("messenger::root") != null) {
			var Messenger = CurrentUser.Messenger;
			var EMail = CurrentUser.EMail;

			if (Messenger != null && (Messenger.LocalState == MSTATE_OFFLINE || Messenger.LocalState == MSTATE_UNKNOWN) && EMail != "")
			{
				Messenger.LogoffReason = MLOGOFFREASON_UNKNOWN;
				Messenger.Logon(EMail, Messenger.Services.PrimaryService);
			}
		}
	}

	function LogoffIM()
	{
		clearTimeout(LoginIMTimeoutID);
		LoginIMTimeoutID = 0;

		if (TVShell.UserManager.CurrentUser) {
			var Messenger = TVShell.UserManager.CurrentUser.Messenger;

			if (Messenger != null) {
				Messenger.LogoffReason = MLOGOFFREASON_NETWORKDOWN;
				if (Messenger.LocalState != MSTATE_OFFLINE)	{
					Messenger.LogOff();
				}
			}
		}
	}


    //
	// HomeNetworking - Eventhandler for Host events
	//
	function OnHostHandler(hnx, he, evt, status)
	{
    	var str="OnHostEvent: event=" + evt + " status=" + status;
	    if (he) {
    	    str += " host=" + he.Name;
    	}
    	TVShell.Message(str);
	}

	//
	// HomeNetworking - Eventhandler for Service events
	//
	function OnServiceHandler(he, se, evt, status)
	{
    	var str="OnServiceEvent: event=" + evt + " status=" + status;
	    if (he) {
    	    str += " host=" + he.Name;
    	}
	    if (se) {
    	    str += " share=" + se.Name;
    	}
    	TVShell.Message(str);
    	
		switch (evt) {
		case HN_EVT_MOUNTED:
		    if (status==0 && se) {
    			// service is up - move storage device under storage manager
	    		var sd = se.NetStorage;					    
			    if (TVShell.StorageManager.Item(sd.Name)==null) {
			        TVShell.StorageManager.Add(sd);
			    }
		    }
		    break;
		    
		case HN_EVT_UNMOUNTED:
		    if (he && se) {
		        var name = "\\\\" + he.Name + "\\" + se.Name;
			    TVShell.StorageManager.Remove(name);
		    }
		    break;
		}
	}	

    //
    // handle server disconnect event for homenetworking
    //  unmount all filesystems for that server
    //
    function OnFileSystemChange(fs, eventId)
    {
		TVShell.Message("OnFileSystemChange: fs=" + fs + " event=" + eventId);
	    if (eventId==0x4000 && HomeNetworking) {   
	        fs = fs.toLowerCase();
    	    var he = HomeNetworking.Item(fs);
    	    if (he) {
	    	    for (i=0; i<he.Count; i++) {
		    	    var se = he.Item(i);
			        if (se.Enabled && se.State==SHARE_STATE_MOUNTED) {
		    	        TVShell.Message("lost server - unmounting \\\\" + he.Name + "\\" + se.Name);
    				    se.UnMount();
    				}
	    		}
	    	}
	    }
    }
    
    
	function StartHomeNetworking()
	{
        HomeNetworking = TVShell.ConnectionManager.HomeNetworking;
	    Sink.AttachEvent(HomeNetworking, "OnHostHandler", OnHostHandler);
        Sink.AttachEvent(HomeNetworking, "OnServiceHandler", OnServiceHandler);
        HomeNetworking.Restore(); // fixme - done by connection manager
	}

	var Result_Positive	= 0;
	var Result_Negative	= 1;
	var Result_Default	= 2;

    function OnPopupWhitelistChange( PopupWhitelistURL )
    {
		popupControlBeingLoaded = new ActiveXObject("Msxml2.DOMDocument");
		popupControlBeingLoaded.async = true;
		popupControlBeingLoaded.resolveExternals = false;
		popupControlBeingLoaded.validateOnParse = false;
		popupControlBeingLoaded.onreadystatechange=OnPopupControlAvail;
		popupControlBeingLoaded.ondataavailable=OnPopupControlAvail;
		popupControlBeingLoaded.load(TVShell.PopupWhitelistURL);
    }

	function OnPopupControlAvail()
    {
		// We do this in case there are several notifications in a row
		// that changed the popupControl list. If so, this would have
		// resulted in several popupControl's being loaded. This function
		// would be called when each one of these has completed. However,
		// the last one may still be loading. As we care only about the 
		// final one, we check to make sure that the LAST popup doc is 
		// finished loading before assigning it to the popupControl variable. 
		var loading = popupControlBeingLoaded;
		if ( loading.readyState == 4 )
		{
			popupControl = loading;
			var nodes =
				popupControl.selectNodes("/popupcontrol/whitelist/entry");
			TVShell.Message( "PopupControl: Got new whitelist" );
			for (var i = 0; nodes && i < nodes.length; i++)
			{
				TVShell.Message(nodes[i].getAttribute("url"));
			}
		}
    }

	// Pop-up panel
	function OnBeforeWindowOpen(panelname, url, urlContext, urlDownload, name, features, dispEvent, result)
	{
		TVShell.Message("OnBeforeWindowOpen("+panelname+", "+url+", "+urlContext+", "+urlDownload+", "+name+", "+features+", "+dispEvent+")");

		// If some event handler before us has decided what to do, then we ignore it
		if (result.Value != Result_Default)
			return;

		//
		// Special feature:  If the home page does a window.open() in a certain way, then
		// bring up a panel.
		//
		if (features.toLowerCase() == "msntv:panel") {
			var CurrentUser = TVShell.UserManager.CurrentUser;

			if (CurrentUser) {
				var HomeEntry = CurrentUser.ServiceList.Item("home::home");
				if (HomeEntry) {
					if (urlContext.toLowerCase().indexOf(HomeEntry.URL.toLowerCase()) == 0) {
						if ( name == "signout" )
						{
						  var txt = "<P>Are you sure you want to sign out of the " + ServiceFullName + "?</P>";
						  var tmp = PanelManager.CustomMessageBox( txt , "", "Sign Out;Cancel", 0, "", false , MGX_ICON_WARNING, MGX_SIZE_SMALL );
						  if ( tmp == 0 ) TVShell.ConnectionManager.ServiceState = Service_ReSignIn;
						  result.Value = Result_Negative;
						  return;
						}
						if ( name == "impanel" )
						{
							if ( diplomaDisplayed( name , "" ) )
							{
								  result.Value = Result_Negative;
								  return;
							}
						}
						TVShell.Message("Showing panel "+name);
						PanelManager.Show(name);
					}
				}

				//
				// Special feature: If MSNRadio service does a window.open() in a certain way, then
				// hide the WMP panel and bring up main panel
				//
				if (panelname == "mediapanel" && name == "main" && url && url.length > 0) {
					var canOpenWindow = false;
					var MSNRadioEntry = CurrentUser.ServiceList.Item("home::radioplus");
					if (MSNRadioEntry && MSNRadioEntry.URL) {
						var path = MSNRadioEntry.URL;

						path = path.substring(0, path.lastIndexOf("/")).toLowerCase();

						if (urlContext.toLowerCase().indexOf(path) == 0)
							canOpenWindow = true;
					}
					if (!canOpenWindow) {
						var MSNRadioNowPlayingEntry = CurrentUser.ServiceList.Item("msnradio::nowplaying");
						if (MSNRadioNowPlayingEntry && MSNRadioNowPlayingEntry.URL) {
							var path = MSNRadioNowPlayingEntry.URL;

							path = path.substring(0, path.lastIndexOf("/")).toLowerCase();

							if (urlContext.toLowerCase().indexOf(path) == 0)
								canOpenWindow = true;
						}
					}
					if (canOpenWindow) {
						PanelManager.Show("main");
						mainPanel.GotoURL(url);
					}
				}
			}

			result.Value = Result_Negative;
			return;
		}

		if (!url || url == "") {
			TVShell.Message("OnBeforeWindowOpen - no URL specified");
			return;
		}

		//
		// If we got here from a button click, then show the popup in a new page
		//
		var DISPID_EVPROP_ONCLICK = -2147412104;
		var DISPID_EVPROP_ONSUBMIT = -2147412101;
		var DISPID_EVPROP_ONCHANGE = -2147412082;

		TVShell.Message("OnBeforeWindowOpen - onclick "+DISPID_EVPROP_ONCLICK);
		TVShell.Message("OnBeforeWindowOpen - dispid is "+dispEvent);

		if ((dispEvent == DISPID_EVPROP_ONCLICK ||
			 dispEvent == DISPID_EVPROP_ONSUBMIT ||
			 dispEvent == DISPID_EVPROP_ONCHANGE ||
			 (urlDownload && urlDownload.indexOf("javascript:") == 0)) &&
			TVShell.Property("NavigatePopUps")) {
			TVShell.Message("OnBeforeWindowOpen - navigate to popup");
			result.Value = Result_Positive;
			return;
		}

		switch (name) {
			case "_blank":
				break;
			case "_media": // Media bar
				TVShell.Message("Open request -> default");
				return;
			case "_search": // Search pane
				TVShell.Message("Open request -> default");
				return;
			case "_parent":  // Frame's parent, or _self
			case "_self": // Same window & frame
			case "_top": // Same window, top frame
				result.Value = Result_Positive;
				return;
		}

		// Check the popup white list.
		if ( popupControl != null ) {
			var nodes =
				popupControl.selectNodes("/popupcontrol/whitelist/entry");
			for (var i = 0; nodes && i < nodes.length; i++) {
				TVShell.Message(nodes[i].getAttribute("url"));
				if (urlContext.toLowerCase().indexOf(nodes[i]
						.getAttribute("url").toLowerCase()) == 0) {
					result.Value = Result_Positive;
					return;
				}
			}
		}

		// If we get here, we aren't navigating to the pop-up. Save the url and make some noise.
		lastSuppressedPopupURL = url;
		TVShell.NotifyPopupBlocked(url);

		if (!TVShell.Property("PopUpsPanel"))
			return;

		var popupname;

		if (TVShell.Property("MultiplePopUps"))
			popupname = "popup::"+name;
		else
			popupname = "popup::";

		var popuppanel = PanelManager.Item(popupname);

		if (!popuppanel) {
			var popup   = new Panel(popupname, "", APP_PANEL_TYPE, SLIDING_PANEL_STYLE,75,0,false);
			popup.start = new Rectangle(safeLeft, screenHeight, safeWidth, LARGE_PANEL_HEIGHT);
			popup.end   = new Rectangle(safeLeft, safeBottom - LARGE_PANEL_HEIGHT, safeWidth,
																				LARGE_PANEL_HEIGHT);
			popuppanel = AddPanel(PanelManager, popup);

			//
			// Set a popup panel accelerator for internal builds only
			//
			if (flavor != "release" && flavor != "ppe")
				SetPanelAccel(popup.name, FALT, "p".charCodeAt(0));  // Alt+u
		}

		if (popuppanel) {
			//
			// Panel is shown (maybe) during navigate complete event
			//
			popuppanel.GotoURL(url);
			popuppanel.StartRect(safeLeft, screenHeight, safeWidth, LARGE_PANEL_HEIGHT);
			popuppanel.EndRect(safeLeft, safeBottom - LARGE_PANEL_HEIGHT,
										 safeWidth, LARGE_PANEL_HEIGHT);
			result.Value = Result_Negative;
		}
	}

	function OnBeforeWindowClose(panelname, childwindow, result)
	{
		TVShell.Message("OnBeforeWindowClose("+panelname+", "+childwindow+")");

		// If some event handler before us has decided what to do, then we ignore it
		if (result.Value != Result_Default)
			return;

		if (panelname.indexOf("popup::") == 0) {
			result.Value = Result_Negative;
			RemovePanel(panelname);
		}
	}

	//
	// OnStartup is fired after the config completed call is made
	//
	function OnStartup()
	{
		//
		// Enable crash logs on first chance exceptions
		//
		TVShell.EventLog.CrashLogMgr.FirstChance = true;

		//
		// Connection Manager
		//
		InitializeConnectionManager();

		// 
		//	Tell the bootrom that we have booted by updating the build number
		//  in the prefs file to the build number of this build
		//
		var rom = new ActiveXObject("MSNTV.BootRom");

		rom.Read();
		rom.BuildNumber = TVShell.SystemInfo.BuildNumber;
		rom.Flush();

		
		// update service hours periodically
		
		UpdateServiceHours();
		setInterval(UpdateServiceHours, 15 * 1000 * 60);

		StartHomeNetworking();

		TVShell.ValidatePersistentInternetCache();
	}

	function OnCapsLockChange(isOn)
	{
		DeviceControl.PlaySound("KeyCapsOn");
	}

    
	//
	// Wire up Javascript Event handlers

	//

	var Sink = new ActiveXObject("MSNTV.MultipleEventSink");

	Sink.AttachEvent(TVShell,					"OnServiceListKeyDown",	 OnServiceListKeyDown);
	Sink.AttachEvent(TVShell,                   "OnPowerOn",             OnPowerOn);
	Sink.AttachEvent(TVShell,                   "OnPowerOff",            OnPowerOff);
	Sink.AttachEvent(TVShell,                   "OnSecretCode",          OnSecretCode);
	Sink.AttachEvent(TVShell,                   "OnMemoryStateChange",   OnMemoryStateChange);
	Sink.AttachEvent(TVShell,                   "OnFileSystemChange",    OnFileSystemChange);
	Sink.AttachEvent(TVShell,                   "OnStartup",   			 OnStartup);
	Sink.AttachEvent(TVShell,					"OnCapsLockChange",		 OnCapsLockChange);
	Sink.AttachEvent(TVShell,					"OnPopupWhitelistChange",OnPopupWhitelistChange);
	Sink.AttachEvent(TVShell.UserManager,       "OnAuthorizationChange", OnAuthorizationChange);
	Sink.AttachEvent(TVShell.UserManager,       "OnBeforeAuthorizationChange", OnBeforeAuthorizationChange);
	Sink.AttachEvent(TVShell.UserManager,       "OnUserAdded",           OnUserAdded);
	Sink.AttachEvent(TVShell.ConnectionManager, "OnServiceStateChange",  OnServiceStateChange);
	Sink.AttachEvent(TVShell.ConnectionManager, "OnWANStateChange",      OnWANStateChange);
	Sink.AttachEvent(TVShell.ConnectionManager, "OnWANConnect",          OnWANConnect);
	Sink.AttachEvent(TVShell.ConnectionManager, "OnLANStateChange",      OnLANStateChange);
	Sink.AttachEvent(TVShell.ConnectionManager, "OnLANConnect",          OnLANConnect);
	Sink.AttachEvent(PanelManager,				"OnDownloadBegin",       OnDownloadBegin);
	Sink.AttachEvent(PanelManager,				"OnDownloadComplete",    OnDownloadComplete);
	Sink.AttachEvent(PanelManager,				"OnDocumentComplete",    OnDocumentComplete);
	Sink.AttachEvent(PanelManager,				"OnBeforeNavigate2",     OnBeforeNavigate2);
	Sink.AttachEvent(PanelManager,				"OnNavigateComplete2",   OnNavigateComplete2);
	Sink.AttachEvent(PanelManager,				"OnURLMONDialog",        OnURLMONDialog);
	Sink.AttachEvent(PanelManager,				"OnWININETDialog",       OnWININETDialog);
	Sink.AttachEvent(PanelManager,				"OnNavigateError",		 OnNavigateError);
	Sink.AttachEvent(PanelManager,				"OnPrintCommand",		 OnPrintCommand);
	Sink.AttachEvent(PanelManager,				"OnBeforeWindowOpen",	 OnBeforeWindowOpen);
	Sink.AttachEvent(PanelManager,				"OnBeforeWindowClose",	 OnBeforeWindowClose);
	Sink.AttachEvent(TVShell.TaskScheduler,		"OnTimeout",		 	 OnTimeout);
	Sink.AttachEvent(TVShell.StorageManager,	"OnDeviceRemove",		 OnDeviceRemove);
	Sink.AttachEvent(TVShell.StorageManager,	"OnDeviceAdd",			 OnDeviceAdd);
	Sink.AttachEvent(TVShell.PrintManager,		"OnPrintDeviceAdd",		 OnPrintDeviceAdd);

	// Called After we attach an event handler so we don't lose any changes
	OnPopupWhitelistChange( TVShell.PopupWhitelistURL );

	//Go ahead and set the popupControl to be the one being loaded .
	popupControl = popupControlBeingLoaded;

	//
	// Add extra start up panels
	//
	AddPanels("Startup");

	//
	// Tell the shell that we're all set to go after waiting just a moment to let the
	// system settle
	//
	setTimeout("TVShell.NotifyConfigCompleted();", 500);
		</SCRIPT>
	</HEAD>
	<BODY>
	</BODY>
</HTML>
